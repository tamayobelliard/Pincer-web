<!DOCTYPE html>
<html>
<head>
  <title>Pincer ‚Äì Restaurant Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    h2 {
      color: white;
      font-size: 1.5em;
      margin-bottom: 15px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    #connection-status {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      font-size: 14px;
    }
    #notification-banner {
      background: rgba(251, 191, 36, 0.95);
      color: #78350f;
      padding: 15px;
      text-align: center;
      border-radius: 12px;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      font-weight: 600;
      display: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    #notification-banner:hover {
      background: rgba(251, 191, 36, 1);
      transform: scale(1.02);
    }
    #notification-banner.show {
      display: block;
    }

    /* ‚îÄ‚îÄ‚îÄ PRODUCTOS / SOLD OUT ‚îÄ‚îÄ‚îÄ */
    .products-panel {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto 24px auto;
    }
    .products-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .products-panel-header h3 {
      font-size: 1.25em;
      color: #1e1b4b;
      margin: 0;
    }
    .products-panel-header .legend {
      display: flex;
      gap: 16px;
      font-size: 0.85em;
      color: #64748b;
    }
    .products-panel-header .legend span {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .legend-dot.available { background: #22c55e; }
    .legend-dot.soldout   { background: #ef4444; }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
    .product-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: border-color 0.2s, background 0.2s;
    }
    .product-card.is-soldout {
      background: #fef2f2;
      border-color: #fca5a5;
    }
    .product-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .product-card-name {
      font-weight: 700;
      font-size: 0.9em;
      color: #1e1b4b;
      line-height: 1.3;
      flex: 1;
      padding-right: 8px;
    }
    .product-card-price {
      font-size: 0.82em;
      color: #64748b;
      white-space: nowrap;
      margin-top: 2px;
    }

    /* Toggle switch */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
    }
    .toggle-label {
      font-size: 0.78em;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .product-card.is-soldout .toggle-label {
      color: #dc2626;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: #22c55e;
      border-radius: 26px;
      cursor: pointer;
      transition: 0.25s;
    }
    .toggle-slider:before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.25s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .toggle-slider {
      background: #ef4444;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .toggle-switch input:focus + .toggle-slider {
      box-shadow: 0 0 0 3px rgba(239,68,68,0.25);
    }

    /* ‚îÄ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ‚îÄ */
    #orders {
      max-width: 1200px;
      margin: 0 auto;
    }
    .order {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 12px;
      border-left: 8px solid #22c55e;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .order:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .new      { border-left-color: #22c55e; background: #f0fdf4; }
    .warning  { border-left-color: #f97316; background: #fff7ed; }
    .late     { border-left-color: #ef4444; background: #fef2f2; animation: pulse 2s infinite; }
    .accepted { border-left-color: #3b82f6; background: #eff6ff; }
    .ready    { border-left-color: #16a34a; background: #f0fdf4; opacity: 0.6; }
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      50%      { opacity: 0.8; box-shadow: 0 0 20px rgba(239,68,68,0.5); }
    }
    .order-number {
      font-size: 32px;
      font-weight: bold;
      color: #1e40af;
      margin-bottom: 10px;
      display: inline-block;
      padding: 5px 15px;
      background: #dbeafe;
      border-radius: 8px;
    }
    .order-items {
      margin: 12px 0;
    }
    .order-items-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .order-item-row {
      background: #f8fafc;
      padding: 8px 12px;
      margin-bottom: 6px;
      border-radius: 6px;
      border-left: 3px solid #cbd5e1;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .order-item-qty {
      font-weight: 700;
      color: #1e40af;
      font-size: 1.1em;
      min-width: 30px;
    }
    .order-item-name {
      flex: 1;
      color: #1e293b;
      font-weight: 600;
    }
    .order-item-notes {
      font-size: 0.9em;
      color: #64748b;
      font-style: italic;
      margin-top: 3px;
    }
    
    /* Extras indentados */
    .order-item-row.is-extra {
      background: #f1f5f9;
      margin-left: 35px;
      border-left-color: #94a3b8;
      padding: 6px 10px;
      font-size: 0.95em;
    }
    .order-item-row.is-extra .order-item-qty {
      font-size: 1em;
      color: #64748b;
    }
    .order-item-row.is-extra .order-item-name {
      color: #475569;
      font-weight: 500;
    }
    
    /* Total de la orden */
    .order-total {
      margin-top: 12px;
      padding: 10px 12px;
      background: linear-gradient(135deg, #4a7c2c, #2d5016);
      color: white;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 1.1em;
    }
    .order-total-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* Alerta de tiempo para √≥rdenes pendientes antiguas */
    .time-alert {
      display: inline-block;
      margin-left: 8px;
      padding: 4px 10px;
      background: #fef3c7;
      color: #92400e;
      border-radius: 6px;
      font-size: 0.85em;
      font-weight: 600;
      animation: alertPulse 1.5s infinite;
    }
    .time-alert.critical {
      background: #fee2e2;
      color: #991b1b;
    }
    @keyframes alertPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .order-time {
      display: inline-block;
      padding: 5px 12px;
      background: #f1f5f9;
      border-radius: 6px;
      font-size: 14px;
      color: #475569;
      margin: 10px 0;
    }
    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status-pending  { background: #fef3c7; color: #92400e; }
    .status-accepted { background: #dbeafe; color: #1e40af; }
    .status-ready    { background: #d1fae5; color: #065f46; }

    button {
      margin-top: 15px;
      margin-right: 10px;
      padding: 12px 24px;
      cursor: pointer;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-accept {
      background: #3b82f6;
      box-shadow: 0 2px 4px rgba(59,130,246,0.3);
    }
    .btn-accept:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59,130,246,0.4);
    }
    .btn-ready {
      background: #16a34a;
      box-shadow: 0 2px 4px rgba(22,163,74,0.3);
    }
    .btn-ready:hover {
      background: #15803d;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(22,163,74,0.4);
    }
    button:active  { transform: translateY(0); }
    button:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      border-left: 4px solid #dc2626;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .completed-badge {
      display: inline-block;
      padding: 5px 12px;
      background: #16a34a;
      color: white;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }
    .stats {
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 12px;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media (max-width: 500px) {
      .stats {
        grid-template-columns: repeat(2, 1fr);
        padding: 16px;
        gap: 10px;
      }
    }
    .stat-item {
      text-align: center;
      background: #f1f5f9;
      border-radius: 10px;
      padding: 12px 8px;
    }
    .stat-number { font-size: 28px; font-weight: bold; color: #1e40af; }
    .stat-label  { font-size: 13px; color: #64748b; margin-top: 4px; }
  </style>
</head>
<body>

<!-- Pantalla de Login -->
<div id="loginScreen" style="
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
">
  <div style="
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 400px;
    width: 90%;
  ">
    <h1 style="text-align: center; color: #2d5016; margin-bottom: 10px; font-size: 2em;">
      üìü Pincer Dashboard
    </h1>
    <p style="text-align: center; color: #64748b; margin-bottom: 30px;">
      Mr. Sandwich by Chef Elly
    </p>
    
    <div id="loginError" style="
      display: none;
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    "></div>
    
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div style="margin-bottom: 20px;">
        <label style="display: block; color: #475569; font-weight: 600; margin-bottom: 8px;">
          Usuario
        </label>
        <input 
          type="text" 
          id="username" 
          required
          style="
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
          "
          placeholder="mrsandwich"
        >
      </div>
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; color: #475569; font-weight: 600; margin-bottom: 8px;">
          Contrase√±a
        </label>
        <input 
          type="password" 
          id="password" 
          required
          style="
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
          "
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        >
      </div>
      
      <button 
        type="submit"
        id="loginBtn"
        style="
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #4a7c2c, #2d5016);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 1.1em;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.2s;
        "
      >
        Iniciar Sesi√≥n
      </button>
    </form>
  </div>
</div>


<h1>üìü Pincer ‚Äì Orders Dashboard</h1>

<!-- Stats Diarios -->
<div id="dailyStatsPanel" style="
  background: rgba(255,255,255,0.95);
  padding: 20px;
  border-radius: 12px;
  max-width: 1200px;
  margin: 0 auto 20px auto;
  display: none;
">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="color: #1e40af; font-size: 1.2em; margin: 0;">
      üìä Resumen del D√≠a
    </h3>
    <button onclick="refreshStats()" style="
      background: #4a7c2c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    ">
      üîÑ Actualizar
    </button>
  </div>
  
  <div style="
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
  ">
    <div class="stat-card">
      <div class="stat-value" id="stat-total-orders">0</div>
      <div class="stat-label">√ìrdenes Totales</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-total-sales" style="color: #059669;">RD$0</div>
      <div class="stat-label">Ventas del D√≠a</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-avg-order">RD$0</div>
      <div class="stat-label">Ticket Promedio</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-completed">0</div>
      <div class="stat-label">Completadas</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-top-product">-</div>
      <div class="stat-label">M√°s Vendido</div>
    </div>
  </div>
</div>

<style>
  .stat-card {
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    border: 2px solid #e2e8f0;
  }
  .stat-value {
    font-size: 1.8em;
    font-weight: bold;
    color: #1e40af;
    margin-bottom: 5px;
  }
  .stat-label {
    font-size: 0.85em;
    color: #64748b;
    font-weight: 600;
  }
</style>

<div id="connection-status">üîÑ Conectando...</div>

<!-- Banner de notificaciones -->
<div id="notification-banner" onclick="requestNotificationPermission()">
  üîî Haz click aqu√≠ para habilitar notificaciones de nuevas √≥rdenes
</div>

<!-- Stats -->
<div class="stats" id="stats">
  <div class="stat-item">
    <div class="stat-number" id="total-orders">0</div>
    <div class="stat-label">Total √ìrdenes</div>
  </div>
  <div class="stat-item">
    <div class="stat-number" id="pending-orders">0</div>
    <div class="stat-label">Pendientes</div>
  </div>
  <div class="stat-item">
    <div class="stat-number" id="preparing-orders">0</div>
    <div class="stat-label">En Preparaci√≥n</div>
  </div>
  <div class="stat-item">
    <div class="stat-number" id="ready-orders">0</div>
    <div class="stat-label">Listas</div>
  </div>
</div>

<div id="error-message"></div>

<div id="orders">
  <div class="loading">‚è≥ Cargando √≥rdenes...</div>
</div>

<!-- Productos / Sold Out -->
<div class="products-panel" id="productsPanel">
  <div class="products-panel-header">
    <h3>üì¶ Productos</h3>
    <div class="legend">
      <span><span class="legend-dot available"></span> Disponible</span>
      <span><span class="legend-dot soldout"></span> Agotado</span>
    </div>
  </div>
  <div class="products-grid" id="productsGrid">
    <!-- se genera por JS -->
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
// ‚îÄ‚îÄ Credenciales ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL     = "https://wtkqpfswpkfgztozgwzl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0a3FwZnN3cGtmZ3p0b3pnd3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mzk1ODQsImV4cCI6MjA4NTExNTU4NH0.g2r56f22VJXmMCs_M1Of-qInsQyPHI5FoRpb9LqB9bI";

// Headers para GET (sin Content-Type ‚Äî Android Chrome falla con CORS si lo incluye en GET)
function sbGetHeaders() {
  return {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
  };
}
// Headers para POST / PATCH / PUT (con Content-Type)
function sbWriteHeaders(extra = {}) {
  return {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
    'Content-Type': 'application/json',
    ...extra
  };
}

// fetch con timeout usando Promise.race ‚Äî m√°s compatible que AbortController en Android
function fetchWithTimeout(url, options = {}, ms = 8000) {
  const timeout = new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Timeout ' + ms + 'ms')), ms)
  );
  return Promise.race([fetch(url, options), timeout]);
}

// ‚îÄ‚îÄ Menu completo (mismo MENU_DATA que en index.html) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MENU_DATA = [
  // munchies
  { id:'yukita',          name:'Yukita Cubana',                   price:600,  cat:'Munchies' },
  { id:'fries',           name:'Mr. Fries',                      price:650,  cat:'Munchies' },
  // sandwiches
  { id:'pastrami',        name:'Mr. Pastrami',                   price:1900, cat:'S√°ndwiches' },
  { id:'chopped',         name:'Chopped Cheese',                 price:1100, cat:'S√°ndwiches' },
  { id:'phillie',         name:'Mr. Phillie Cheese Steak',       price:950,  cat:'S√°ndwiches' },
  { id:'smash',           name:'Ellys Classic Smashburger',      price:850,  cat:'S√°ndwiches' },
  { id:'pierna',          name:'Sanguche de Pierna',             price:700,  cat:'S√°ndwiches' },
  { id:'cubano',          name:'Cubano',                         price:700,  cat:'S√°ndwiches' },
  { id:'club',            name:'Club Sandwich',                  price:700,  cat:'S√°ndwiches' },
  { id:'chimi',           name:'El Chimichurri',                 price:650,  cat:'S√°ndwiches' },
  // extras
  { id:'extra_tocineta',  name:'Extra Tocineta',                 price:100,  cat:'Extras' },
  { id:'extra_fondue',    name:'Extra Fondue de Queso Velveeta', price:100,  cat:'Extras' },
  { id:'extra_salsita',   name:'Extra Salsita de Ajo y Perejil', price:50,   cat:'Extras' },
  { id:'extra_mayo',      name:'Extra Ellys Mayo',              price:50,   cat:'Extras' }
];

// ‚îÄ‚îÄ Estado global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let soldOutSet      = new Set();   // IDs actualmente agotados
let lastOrderCount  = 0;
let hasInteracted   = false;       // reemplaza hasPlayedSound

// ‚îÄ‚îÄ AudioContext (mismo patr√≥n que index.html) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx = null;
function ensureAudioContext() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}
['click','touchstart'].forEach(e => document.addEventListener(e, ensureAudioContext, { once: true }));

function playBeeps(freqs, volume = 0.4) {
  try {
    if (!audioCtx) return;
    ensureAudioContext();
    const now = audioCtx.currentTime;
    freqs.forEach((freq, i) => {
      const osc  = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(volume, now + i * 0.18);
      gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.18 + 0.15);
      osc.start(now + i * 0.18);
      osc.stop(now  + i * 0.18 + 0.16);
    });
  } catch (e) { /* silente */ }
}

// Nueva orden: 3 beeps ascendentes r√°pidos
function playNewOrderSound()   { playBeeps([660, 880, 1100]); }
// Confirmaci√≥n (aceptar / marcar lista): 2 beeps suaves
function playConfirmSound()    { playBeeps([440, 660], 0.3); }

// ‚îÄ‚îÄ Utilidades ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showError(msg) {
  document.getElementById("error-message").innerHTML = `<div class="error">‚ùå ${msg}</div>`;
}
function clearError() {
  document.getElementById("error-message").innerHTML = '';
}

function updateStats(orders) {
  document.getElementById('total-orders').textContent     = orders.length;
  document.getElementById('pending-orders').textContent   = orders.filter(o => o.status === 'pending' || !o.status).length;
  document.getElementById('preparing-orders').textContent = orders.filter(o => o.status === 'accepted').length;
  document.getElementById('ready-orders').textContent     = orders.filter(o => o.status === 'ready').length;
}

// ‚îÄ‚îÄ Notificaciones de navegador ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function requestNotificationPermission() {
  if (!("Notification" in window)) { alert("Tu navegador no soporta notificaciones"); return; }
  try {
    const perm = await Notification.requestPermission();
    if (perm === "granted") {
      document.getElementById('notification-banner').classList.remove('show');
      new Notification("¬°Notificaciones Habilitadas!", {
        body: "Te avisaremos cuando lleguen nuevas √≥rdenes a Pincer",
        icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üîî</text></svg>",
        tag: "pincer-notifications-enabled"
      });
    } else if (perm === "denied") {
      alert("‚ö†Ô∏è Has bloqueado las notificaciones.\n\n1. Click en el √≠cono del candado üîí\n2. Busca 'Notificaciones'\n3. Cambia a 'Permitir'");
    }
  } catch (e) { console.error("requestNotificationPermission:", e); }
}

function sendNotification(title, body, tag) {
  try {
    if (typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
    console.log("üì± Enviando notificaci√≥n:", title);
    const n = new Notification(title, {
      body,
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üçî</text></svg>",
      tag: tag || ('pincer-' + Date.now()),
      requireInteraction: true
    });
    n.onclick = function() { window.focus(); this.close(); };
  } catch (e) { /* silente */ }
}

// ‚îÄ‚îÄ PRODUCTOS: cargar + renderizar + togglear ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProducts() {
  console.log("üü¢ loadProducts iniciado");
  try {
    console.log("üü¢ fetch products URL:", SUPABASE_URL + '/rest/v1/products?select=id,sold_out');
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/products?select=id,sold_out',
      { headers: sbGetHeaders() }
    );
    console.log("üü¢ fetch products completado, status:", res.status);
    if (!res.ok) {
      // Tabla puede no existir a√∫n ‚Üí no es error fatal, renderizar todo disponible
      console.warn("‚ö†Ô∏è products table HTTP error " + res.status);
      soldOutSet = new Set();
      renderProducts();
      return;
    }
    const rows = await res.json();
    soldOutSet = new Set(rows.filter(r => r.sold_out).map(r => r.id));
    console.log("‚úÖ Productos cargados, agotados:", [...soldOutSet]);
  } catch (e) {
    console.warn("‚ö†Ô∏è loadProducts catch:", e.name, e.message);
    soldOutSet = new Set();
  }
  renderProducts();
}

function renderProducts() {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';

  MENU_DATA.forEach(item => {
    const isSoldOut = soldOutSet.has(item.id);

    const card = document.createElement('div');
    card.className = 'product-card' + (isSoldOut ? ' is-soldout' : '');
    card.id = 'prodCard_' + item.id;
    card.innerHTML = `
      <div class="product-card-top">
        <div>
          <div class="product-card-name">${item.name}</div>
          <div class="product-card-price">RD$${item.price.toLocaleString()}</div>
        </div>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">${isSoldOut ? 'Agotado' : 'Disponible'}</span>
        <label class="toggle-switch">
          <input type="checkbox" ${isSoldOut ? 'checked' : ''} onchange="toggleSoldOut('${item.id}', this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>`;
    grid.appendChild(card);
  });
}

async function toggleSoldOut(productId, isSoldOut) {
  // Optimistic update inmediato
  if (isSoldOut) soldOutSet.add(productId); else soldOutSet.delete(productId);
  updateProductCardUI(productId, isSoldOut);

  try {
    // UPSERT: si existe actualiza, si no existe lo inserta
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/products',
      {
        method: 'POST',
        headers: sbWriteHeaders({ 'Prefer': 'resolution=merge-duplicates' }),
        body: JSON.stringify({ id: productId, sold_out: isSoldOut })
      }
    );
    if (!res.ok) {
      const txt = await res.text();
      console.error("‚ùå toggleSoldOut upsert ‚Üí", res.status, txt);
      // Revertir si fall√≥
      if (isSoldOut) soldOutSet.delete(productId); else soldOutSet.add(productId);
      updateProductCardUI(productId, !isSoldOut);
      showError("No se pudo actualizar el producto. Verifica la conexi√≥n.");
      return;
    }
    console.log("‚úÖ Producto", productId, "‚Üí sold_out:", isSoldOut);
    clearError();
  } catch (e) {
    console.error("‚ùå toggleSoldOut:", e.message);
    // Revertir
    if (isSoldOut) soldOutSet.delete(productId); else soldOutSet.add(productId);
    updateProductCardUI(productId, !isSoldOut);
    showError("Error de conexi√≥n al actualizar producto.");
  }
}

function updateProductCardUI(productId, isSoldOut) {
  const card  = document.getElementById('prodCard_' + productId);
  if (!card) return;
  const label = card.querySelector('.toggle-label');
  const chk   = card.querySelector('input[type=checkbox]');

  card.classList.toggle('is-soldout', isSoldOut);
  label.textContent = isSoldOut ? 'Agotado' : 'Disponible';
  chk.checked       = isSoldOut;
}


// ‚îÄ‚îÄ Renderizar items como lista estructurada ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOrderItems(itemsJSON) {
  try {
    const items = JSON.parse(itemsJSON);
    if (!items || !Array.isArray(items) || items.length === 0) {
      return '<li class="order-item-row"><span class="order-item-name">Sin especificar</span></li>';
    }
    
    // Agrupar: item principal + sus extras (los que tienen nota "para X")
    let html = '';
    let i = 0;
    while (i < items.length) {
      const item = items[i];
      const isExtra = item.id && item.id.startsWith('extra_');
      
      if (!isExtra) {
        // Item principal
        const notesHTML = item.notes 
          ? `<div class="order-item-notes">¬∑ ${item.notes}</div>`
          : '';
        html += `
          <li class="order-item-row">
            <span class="order-item-qty">${item.qty}x</span>
            <div style="flex: 1;">
              <div class="order-item-name">${item.name}</div>
              ${notesHTML}
            </div>
          </li>`;
        
        // Buscar extras vinculados a este item (nota contiene "para [nombre]")
        const linkedExtras = [];
        for (let j = i + 1; j < items.length; j++) {
          const next = items[j];
          if (next.id && next.id.startsWith('extra_') && 
              next.notes && next.notes.includes(`para ${item.name}`)) {
            linkedExtras.push({ item: next, index: j });
          }
        }
        
        // Renderizar extras vinculados indentados
        linkedExtras.forEach(({ item: extra }) => {
          html += `
            <li class="order-item-row is-extra">
              <span class="order-item-qty">${extra.qty}x</span>
              <div style="flex: 1;">
                <div class="order-item-name">${extra.name}</div>
              </div>
            </li>`;
        });
        
        // Marcar los extras ya procesados para saltarlos
        linkedExtras.forEach(({ index }) => {
          items[index]._processed = true;
        });
      } else if (!item._processed) {
        // Extra suelto (no vinculado, caso edge)
        html += `
          <li class="order-item-row is-extra">
            <span class="order-item-qty">${item.qty}x</span>
            <div style="flex: 1;">
              <div class="order-item-name">${item.name}</div>
            </div>
          </li>`;
      }
      i++;
    }
    
    return html;
  } catch (e) {
    // Fallback por si el formato viejo sigue en la DB
    return `<li class="order-item-row"><span class="order-item-name">${itemsJSON || 'Sin especificar'}</span></li>`;
  }
}

// ‚îÄ‚îÄ √ìRDENES: cargar + renderizar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadOrders() {
  console.log("üîµ loadOrders iniciado");
  try {
    console.log("üîµ fetch orders URL:", SUPABASE_URL + '/rest/v1/orders?select=*&order=created_at.desc');
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/orders?select=*&order=created_at.desc',
      { headers: sbGetHeaders() }
    );
    console.log("üîµ fetch orders completado, status:", res.status);
    if (!res.ok) {
      console.error("‚ùå loadOrders HTTP error", res.status);
      showError("Error al cargar √≥rdenes (HTTP " + res.status + ")");
      document.getElementById("connection-status").innerHTML = "üî¥ Desconectado";
      return;
    }
    const data = await res.json();

    document.getElementById("connection-status").innerHTML = "üü¢ Conectado";

    const container = document.getElementById("orders");

    if (!data || data.length === 0) {
      container.innerHTML = "<div class='loading'>‚úÖ No hay √≥rdenes pendientes</div>";
      updateStats([]);
      lastOrderCount = 0;
      hasInteracted  = true;
      return;
    }

    updateStats(data);

    // ‚îÄ‚îÄ Detectar nueva orden ‚îÄ‚îÄ
    const currentPending = data.filter(o => o.status === 'pending' || !o.status).length;

    if (hasInteracted && currentPending > lastOrderCount) {
      console.log("üîî Nueva orden detectada");
      playNewOrderSound();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
      sendNotification(
        "¬°Nueva orden en Pincer!",
        `Tienes ${currentPending} orden(es) pendiente(s)`
      );
    }

    lastOrderCount = currentPending;
    hasInteracted  = true;

    // ‚îÄ‚îÄ Renderizar √≥rdenes ‚îÄ‚îÄ
    container.innerHTML = '';

    data.forEach(order => {
      const createdAt = new Date(order.created_at);
      const minutes   = Math.floor((Date.now() - createdAt.getTime()) / 60000);
      const status    = order.status || 'pending';

      let statusClass = 'new';
      if      (status === 'ready')    statusClass = 'ready';
      else if (status === 'accepted') statusClass = 'accepted';
      else if (minutes > 5)           statusClass = 'late';
      else if (minutes > 2)           statusClass = 'warning';

      let statusBadgeClass, statusText;
      if      (status === 'ready')    { statusBadgeClass = 'status-ready';    statusText = '‚úì LISTA PARA RETIRAR'; }
      else if (status === 'accepted') { statusBadgeClass = 'status-accepted'; statusText = 'üë®‚Äçüç≥ EN PREPARACI√ìN'; }
      else                            { statusBadgeClass = 'status-pending';  statusText = '‚è≥ PENDIENTE'; }

      const div = document.createElement("div");
      div.className = `order ${statusClass}`;
      div.innerHTML = `
        <div class="order-number">#${order.id}</div>
        <span class="order-status ${statusBadgeClass}">${statusText}</span>
        <div class="order-items">
          <strong style="color: #1e40af; font-size: 0.95em;">üìã ITEMS:</strong>
          <ul class="order-items-list">
            ${renderOrderItems(order.items)}
          </ul>
        </div>
        <div class="order-total">
          <span class="order-total-label">üíµ TOTAL A COBRAR:</span>
          <span>RD${(order.total || 0).toLocaleString()}</span>
        </div>
        <div class="order-time">
          ‚è±Ô∏è Hace ${minutes} minuto${minutes !== 1 ? 's' : ''}
          ${status === 'pending' && minutes >= 2 ? `<span class="time-alert ${minutes >= 3 ? 'critical' : ''}">‚ö†Ô∏è URGENTE</span>` : ''}
        </div>
        <br>
        ${status === 'pending'  ? `<button class="btn-accept" onclick="acceptOrder(${order.id})">‚úÖ Marcar como digitada</button>` : ''}
        ${status === 'accepted' ? `<button class="btn-ready"  onclick="markReady(${order.id})">üéâ Marcar como LISTA</button>`  : ''}
        ${status === 'ready'    ? `<span class="completed-badge">‚úì COMPLETADA - Cliente notificado</span>` : ''}`;
      container.appendChild(div);
    });

    clearError();
  } catch (err) {
    console.error("‚ùå loadOrders catch:", err.name, err.message);
    showError("Error inesperado: " + err.message);
    document.getElementById("connection-status").innerHTML = "üî¥ Error de conexi√≥n";
  }
}

// ‚îÄ‚îÄ Aceptar orden (pending ‚Üí accepted) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function acceptOrder(id) {
  try {
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/orders?id=eq.' + id,
      {
        method: 'PATCH',
        headers: sbWriteHeaders(),
        body: JSON.stringify({ status: 'accepted' })
      }
    );
    if (!res.ok) {
      showError("Error al marcar orden #" + id);
      return;
    }
    console.log("‚úÖ Orden #" + id + " ‚Üí accepted");
    playConfirmSound();
    setTimeout(loadOrders, 150);
  } catch (e) {
    console.error("acceptOrder:", e);
    showError("Error inesperado al aceptar orden.");
  }
}

// ‚îÄ‚îÄ Marcar lista (accepted ‚Üí ready) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function markReady(id) {
  try {
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/orders?id=eq.' + id,
      {
        method: 'PATCH',
        headers: sbWriteHeaders(),
        body: JSON.stringify({ status: 'ready' })
      }
    );
    if (!res.ok) {
      showError("Error al marcar orden #" + id + " como lista");
      return;
    }
    console.log("‚úÖ Orden #" + id + " ‚Üí ready");
    playConfirmSound();
    setTimeout(loadOrders, 150);
  } catch (e) {
    console.error("markReady:", e);
    showError("Error inesperado al marcar como lista.");
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Catch global de errores
window.addEventListener('error', (e) => {
  console.error('‚ùå Error global:', e.message, e.filename, e.lineno);
  document.getElementById("connection-status").innerHTML = "üî¥ Error: " + e.message;
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('‚ùå Promise sin catch:', e.reason);
  document.getElementById("connection-status").innerHTML = "üî¥ Promise error";
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTHENTICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  loginBtn.disabled = true;
  loginBtn.textContent = 'Verificando...';
  loginError.style.display = 'none';
  try {
    const res = await fetchWithTimeout(SUPABASE_URL + '/rest/v1/rpc/verify_dashboard_login', {
      method: 'POST',
      headers: sbWriteHeaders(),
      body: JSON.stringify({ p_username: username, p_password: password })
    }, 8000);
    if (!res.ok) throw new Error('Error de conexi√≥n');
    const result = await res.json();
    const data = Array.isArray(result) ? result[0] : result;
    if (data && data.success) {
      sessionStorage.setItem('dashboard_session', JSON.stringify({userId: data.user_id, restaurantId: data.restaurant_id, username: username}));
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dailyStatsPanel').style.display = 'block';
      initializeDashboard();
    } else {
      loginError.textContent = 'Usuario o contrase√±a incorrectos';
      loginError.style.display = 'block';
    }
  } catch (err) {
    console.error('Login error:', err);
    loginError.textContent = 'Error al conectar. Intenta de nuevo.';
    loginError.style.display = 'block';
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'Iniciar Sesi√≥n';
  }
}

function checkSession() {
  const sessionStr = sessionStorage.getItem('dashboard_session');
  if (!sessionStr) return false;
  try {
    const session = JSON.parse(sessionStr);
    return true;
  } catch (e) {
    return false;
  }
}

async function refreshStats() {
  try {
    const res = await fetchWithTimeout(SUPABASE_URL + '/rest/v1/rpc/get_daily_stats', {
      method: 'POST',
      headers: sbWriteHeaders(),
      body: JSON.stringify({})
    }, 8000);
    if (!res.ok) { console.error('Stats fetch error:', res.status); return; }
    const stats = await res.json();
    if (stats && stats.length > 0) {
      const data = stats[0];
      document.getElementById('stat-total-orders').textContent = data.total_orders || 0;
      document.getElementById('stat-total-sales').textContent = 'RD$' + (data.total_sales || 0).toLocaleString();
      document.getElementById('stat-avg-order').textContent = 'RD$' + Math.round(data.avg_order_value || 0).toLocaleString();
      document.getElementById('stat-completed').textContent = data.completed_orders || 0;
      document.getElementById('stat-top-product').textContent = data.top_product === 'N/A' ? '-' : data.top_product;
    }
  } catch (err) { console.error('Stats error:', err); }
}

async function dailyCleanup() {
  try {
    const res = await fetchWithTimeout(SUPABASE_URL + '/rest/v1/rpc/reset_daily_orders', {
      method: 'POST',
      headers: sbWriteHeaders(),
      body: JSON.stringify({})
    }, 8000);
    if (res.ok) {
      const result = await res.json();
      console.log('Daily cleanup: archivadas', result, '√≥rdenes del d√≠a anterior');
    }
  } catch (err) { console.error('Daily cleanup error:', err); }
}

function initializeDashboard() {
  console.log("üöÄ Iniciando Pincer Dashboard...");
  dailyCleanup();
  refreshStats();
  if ("Notification" in window) {
    if (Notification.permission === "default") document.getElementById('notification-banner').classList.add('show');
    else if (Notification.permission === "granted") {
      try {
        new Notification("Pincer Dashboard Iniciado", {
          body: "Dashboard activo. Te notificaremos de nuevas √≥rdenes.",
          icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üìü</text></svg>",
          tag: "pincer-dashboard-ready"
        });
      } catch (e) { console.log("Notificaci√≥n de bienvenida no soportada en este navegador"); }
    } else if (Notification.permission === "denied") {
      showError("Las notificaciones est√°n bloqueadas. Click en el candado üîí para habilitarlas.");
    }
  }
  loadProducts();
  loadOrders();
  setInterval(loadOrders, 3000);
  setInterval(refreshStats, 30000);
  setInterval(loadProducts, 30000);
  document.addEventListener('click', () => { hasInteracted = true; ensureAudioContext(); }, { once: true });
  console.log("‚úÖ Pincer Dashboard configurado");
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI ASSISTANT CHATBOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleAIChat() {
  const window = document.getElementById('aiChatWindow');
  const btn = document.getElementById('aiAssistantBtn');
  
  if (window.style.display === 'none' || !window.style.display) {
    window.style.display = 'flex';
    btn.textContent = '‚úï';
  } else {
    window.style.display = 'none';
    btn.textContent = 'ü§ñ';
  }
}

function addAIMessage(message, isUser = false) {
  const container = document.getElementById('aiChatMessages');
  const messageDiv = document.createElement('div');
  
  messageDiv.style.cssText = `
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 10px;
    ${isUser 
      ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: 40px; text-align: right;' 
      : 'background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);'
    }
  `;
  
  messageDiv.innerHTML = isUser ? message : 'ü§ñ ' + message;
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

async function sendAIMessage() {
  const input = document.getElementById('aiChatInput');
  const loading = document.getElementById('aiChatLoading');
  const question = input.value.trim();
  
  if (!question) return;
  
  // Agregar mensaje del usuario
  addAIMessage(question, true);
  input.value = '';
  loading.style.display = 'block';
  
  try {
    // 1. Obtener datos de ventas de Supabase
    const salesData = await fetchSalesData();
    
    // 2. Enviar a Claude API para an√°lisis
    const answer = await askClaudeAI(question, salesData);
    
    // 3. Mostrar respuesta
    addAIMessage(answer);
    
  } catch (error) {
    console.error('AI Error:', error);
    addAIMessage('Lo siento, tuve un problema al analizar los datos. ¬øPuedes intentar de nuevo?');
  } finally {
    loading.style.display = 'none';
  }
}

async function fetchSalesData() {
  try {
    // Obtener √∫ltimos 30 d√≠as de datos
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    const startDateStr = startDate.toISOString().split('T')[0];
    
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/rpc/get_sales_data',
      {
        method: 'POST',
        headers: sbWriteHeaders(),
        body: JSON.stringify({
          p_start_date: startDateStr,
          p_end_date: new Date().toISOString().split('T')[0]
        })
      },
      8000
    );
    
    if (!res.ok) {
      throw new Error('Error fetching sales data');
    }
    
    return await res.json();
  } catch (error) {
    console.error('Error fetching sales data:', error);
    return [];
  }
}

async function askClaudeAI(question, salesData) {
  try {
    const systemPrompt = `You are a friendly restaurant sales analyst assistant for Mr. Sandwich by Chef Elly.

You have access to daily sales data with these fields:
- date: fecha de la venta
- total_orders: total de √≥rdenes del d√≠a
- total_sales: ventas totales en RD$ (pesos dominicanos)
- avg_ticket: ticket promedio
- top_item: producto m√°s vendido
- top_item_count: cantidad del top item
- peak_hour: hora pico (0-23)
- peak_hour_orders: √≥rdenes en hora pico

IMPORTANT RULES:
1. Always respond in Spanish
2. Use a friendly, conversational tone (like talking to the restaurant owner)
3. Format numbers with commas for readability (e.g., RD$1,500)
4. When showing dates, use format: "Lunes 5 de Febrero"
5. Use emojis to make responses engaging: üìäüí∞üéâüìà
6. If data is empty or insufficient, be honest and helpful
7. Keep responses concise (2-3 paragraphs max)
8. Always end with a helpful insight or suggestion

Sales Data:
${JSON.stringify(salesData, null, 2)}`;

    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        system: systemPrompt,
        messages: [
          {
            role: 'user',
            content: question
          }
        ]
      })
    });
    
    if (!res.ok) {
      throw new Error('Claude API error');
    }
    
    const data = await res.json();
    const answer = data.content.find(c => c.type === 'text')?.text || 'No pude generar una respuesta.';
    
    return answer;
    
  } catch (error) {
    console.error('Claude API error:', error);
    throw error;
  }
}


document.addEventListener('DOMContentLoaded', () => {
  if (checkSession()) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dailyStatsPanel').style.display = 'block';
    initializeDashboard();
  }
});

</script>

<!-- AI Assistant Chatbot -->
<div id="aiAssistantContainer" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
">
  <!-- Bot√≥n flotante -->
  <button id="aiAssistantBtn" onclick="toggleAIChat()" style="
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-size: 2em;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(102,126,234,0.5);
    transition: all 0.3s;
  ">
    ü§ñ
  </button>
  
  <!-- Ventana del chat -->
  <div id="aiChatWindow" style="
    display: none;
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 400px;
    max-width: 90vw;
    height: 500px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    flex-direction: column;
    overflow: hidden;
  ">
    <!-- Header -->
    <div style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <div style="font-weight: bold; font-size: 1.1em;">ü§ñ Asistente de Ventas</div>
        <div style="font-size: 0.85em; opacity: 0.9;">Tu gerente virtual</div>
      </div>
      <button onclick="toggleAIChat()" style="
        background: none;
        border: none;
        color: white;
        font-size: 1.5em;
        cursor: pointer;
        width: 30px;
        height: 30px;
      ">√ó</button>
    </div>
    
    <!-- Messages -->
    <div id="aiChatMessages" style="
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
    ">
      <div class="ai-message" style="
        background: white;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      ">
        üëã Hola! Soy tu asistente de ventas. Puedo ayudarte a analizar tus datos.<br><br>
        Preg√∫ntame cosas como:<br>
        ‚Ä¢ ¬øCu√°nto vend√≠ hoy?<br>
        ‚Ä¢ ¬øCu√°l fue mi mejor d√≠a este mes?<br>
        ‚Ä¢ ¬øQu√© producto se vende m√°s?<br>
        ‚Ä¢ ¬øA qu√© hora tengo m√°s pedidos?
      </div>
    </div>
    
    <!-- Input -->
    <div style="
      padding: 15px;
      border-top: 1px solid #e2e8f0;
      background: white;
    ">
      <div style="display: flex; gap: 8px;">
        <input 
          type="text" 
          id="aiChatInput" 
          placeholder="Escribe tu pregunta..."
          onkeypress="if(event.key==='Enter') sendAIMessage()"
          style="
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
          "
        >
        <button onclick="sendAIMessage()" style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
        ">
          Enviar
        </button>
      </div>
      <div id="aiChatLoading" style="
        display: none;
        margin-top: 10px;
        text-align: center;
        color: #667eea;
        font-size: 0.9em;
      ">
        ü§î Analizando datos...
      </div>
    </div>
  </div>
</div>

</body>
</html>


