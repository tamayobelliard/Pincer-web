<!DOCTYPE html>
<html>
<head>
  <title>Pincer â€“ Restaurant Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    h2 {
      color: white;
      font-size: 1.5em;
      margin-bottom: 15px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    #connection-status {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      font-size: 14px;
    }
    #notification-banner {
      background: rgba(251, 191, 36, 0.95);
      color: #78350f;
      padding: 15px;
      text-align: center;
      border-radius: 12px;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      font-weight: 600;
      display: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    #notification-banner:hover {
      background: rgba(251, 191, 36, 1);
      transform: scale(1.02);
    }
    #notification-banner.show {
      display: block;
    }

    /* â”€â”€â”€ PRODUCTOS / SOLD OUT â”€â”€â”€ */
    .products-panel {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto 24px auto;
    }
    .products-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .products-panel-header h3 {
      font-size: 1.25em;
      color: #1e1b4b;
      margin: 0;
    }
    .products-panel-header .legend {
      display: flex;
      gap: 16px;
      font-size: 0.85em;
      color: #64748b;
    }
    .products-panel-header .legend span {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .legend-dot.available { background: #22c55e; }
    .legend-dot.soldout   { background: #ef4444; }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
    .product-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: border-color 0.2s, background 0.2s;
    }
    .product-card.is-soldout {
      background: #fef2f2;
      border-color: #fca5a5;
    }
    .product-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .product-card-name {
      font-weight: 700;
      font-size: 0.9em;
      color: #1e1b4b;
      line-height: 1.3;
      flex: 1;
      padding-right: 8px;
    }
    .product-card-price {
      font-size: 0.82em;
      color: #64748b;
      white-space: nowrap;
      margin-top: 2px;
    }

    /* Toggle switch */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
    }
    .toggle-label {
      font-size: 0.78em;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .product-card.is-soldout .toggle-label {
      color: #dc2626;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: #22c55e;
      border-radius: 26px;
      cursor: pointer;
      transition: 0.25s;
    }
    .toggle-slider:before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.25s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .toggle-slider {
      background: #ef4444;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .toggle-switch input:focus + .toggle-slider {
      box-shadow: 0 0 0 3px rgba(239,68,68,0.25);
    }

    /* â”€â”€â”€ ORDERS â”€â”€â”€ */
    #orders {
      max-width: 1200px;
      margin: 0 auto;
    }
    .order {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 12px;
      border-left: 8px solid #22c55e;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .order:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .new      { border-left-color: #22c55e; background: #f0fdf4; }
    .warning  { border-left-color: #f97316; background: #fff7ed; }
    .late     { border-left-color: #ef4444; background: #fef2f2; animation: pulse 2s infinite; }
    .accepted { border-left-color: #3b82f6; background: #eff6ff; }
    .ready    { border-left-color: #16a34a; background: #f0fdf4; opacity: 0.6; }
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      50%      { opacity: 0.8; box-shadow: 0 0 20px rgba(239,68,68,0.5); }
    }
    .order-number {
      font-size: 32px;
      font-weight: bold;
      color: #1e40af;
      margin-bottom: 10px;
      display: inline-block;
      padding: 5px 15px;
      background: #dbeafe;
      border-radius: 8px;
    }
    .order-items {
      font-size: 18px;
      margin: 10px 0;
      color: #334155;
      line-height: 1.6;
    }
    .order-time {
      display: inline-block;
      padding: 5px 12px;
      background: #f1f5f9;
      border-radius: 6px;
      font-size: 14px;
      color: #475569;
      margin: 10px 0;
    }
    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status-pending  { background: #fef3c7; color: #92400e; }
    .status-accepted { background: #dbeafe; color: #1e40af; }
    .status-ready    { background: #d1fae5; color: #065f46; }

    button {
      margin-top: 15px;
      margin-right: 10px;
      padding: 12px 24px;
      cursor: pointer;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-accept {
      background: #3b82f6;
      box-shadow: 0 2px 4px rgba(59,130,246,0.3);
    }
    .btn-accept:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59,130,246,0.4);
    }
    .btn-ready {
      background: #16a34a;
      box-shadow: 0 2px 4px rgba(22,163,74,0.3);
    }
    .btn-ready:hover {
      background: #15803d;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(22,163,74,0.4);
    }
    button:active  { transform: translateY(0); }
    button:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      border-left: 4px solid #dc2626;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .completed-badge {
      display: inline-block;
      padding: 5px 12px;
      background: #16a34a;
      color: white;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }
    .stats {
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 12px;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media (max-width: 500px) {
      .stats {
        grid-template-columns: repeat(2, 1fr);
        padding: 16px;
        gap: 10px;
      }
    }
    .stat-item {
      text-align: center;
      background: #f1f5f9;
      border-radius: 10px;
      padding: 12px 8px;
    }
    .stat-number { font-size: 28px; font-weight: bold; color: #1e40af; }
    .stat-label  { font-size: 13px; color: #64748b; margin-top: 4px; }
  </style>
</head>
<body>

<h1>ğŸ“Ÿ Pincer â€“ Orders Dashboard</h1>
<div id="connection-status">ğŸ”„ Conectando...</div>

<!-- Banner de notificaciones -->
<div id="notification-banner" onclick="requestNotificationPermission()">
  ğŸ”” Haz click aquÃ­ para habilitar notificaciones de nuevas Ã³rdenes
</div>

<!-- Stats -->
<div class="stats" id="stats">
  <div class="stat-item">
    <div class="stat-number" id="total-orders">0</div>
    <div class="stat-label">Total Ã“rdenes</div>
  </div>
  <div class="stat-item">
    <div class="stat-number" id="pending-orders">0</div>
    <div class="stat-label">Pendientes</div>
  </div>
  <div class="stat-item">
    <div class="stat-number" id="preparing-orders">0</div>
    <div class="stat-label">En PreparaciÃ³n</div>
  </div>
  <div class="stat-item">
    <div class="stat-number" id="ready-orders">0</div>
    <div class="stat-label">Listas</div>
  </div>
</div>

<div id="error-message"></div>

<div id="orders">
  <div class="loading">â³ Cargando Ã³rdenes...</div>
</div>

<!-- Productos / Sold Out -->
<div class="products-panel" id="productsPanel">
  <div class="products-panel-header">
    <h3>ğŸ“¦ Productos</h3>
    <div class="legend">
      <span><span class="legend-dot available"></span> Disponible</span>
      <span><span class="legend-dot soldout"></span> Agotado</span>
    </div>
  </div>
  <div class="products-grid" id="productsGrid">
    <!-- se genera por JS -->
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€ Credenciales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL     = "https://wtkqpfswpkfgztozgwzl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0a3FwZnN3cGtmZ3p0b3pnd3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mzk1ODQsImV4cCI6MjA4NTExNTU4NH0.g2r56f22VJXmMCs_M1Of-qInsQyPHI5FoRpb9LqB9bI";

// Headers para GET (sin Content-Type â€” Android Chrome falla con CORS si lo incluye en GET)
function sbGetHeaders() {
  return {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
  };
}
// Headers para POST / PATCH / PUT (con Content-Type)
function sbWriteHeaders(extra = {}) {
  return {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
    'Content-Type': 'application/json',
    ...extra
  };
}

// fetch con timeout usando Promise.race â€” mÃ¡s compatible que AbortController en Android
function fetchWithTimeout(url, options = {}, ms = 8000) {
  const timeout = new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Timeout ' + ms + 'ms')), ms)
  );
  return Promise.race([fetch(url, options), timeout]);
}

// â”€â”€ Menu completo (mismo MENU_DATA que en index.html) â”€â”€â”€â”€â”€â”€â”€
const MENU_DATA = [
  // munchies
  { id:'yukita',          name:'Yukita Cubana',                   price:600,  cat:'Munchies' },
  { id:'fries',           name:'Mr. Fries',                      price:650,  cat:'Munchies' },
  // sandwiches
  { id:'pastrami',        name:'Mr. Pastrami',                   price:1900, cat:'SÃ¡ndwiches' },
  { id:'chopped',         name:'Chopped Cheese',                 price:1100, cat:'SÃ¡ndwiches' },
  { id:'phillie',         name:'Mr. Phillie Cheese Steak',       price:950,  cat:'SÃ¡ndwiches' },
  { id:'smash',           name:'Ellys Classic Smashburger',      price:850,  cat:'SÃ¡ndwiches' },
  { id:'pierna',          name:'Sanguche de Pierna',             price:700,  cat:'SÃ¡ndwiches' },
  { id:'cubano',          name:'Cubano',                         price:700,  cat:'SÃ¡ndwiches' },
  { id:'club',            name:'Club Sandwich',                  price:700,  cat:'SÃ¡ndwiches' },
  { id:'chimi',           name:'El Chimichurri',                 price:650,  cat:'SÃ¡ndwiches' },
  // extras
  { id:'extra_tocineta',  name:'Extra Tocineta',                 price:100,  cat:'Extras' },
  { id:'extra_fondue',    name:'Extra Fondue de Queso Velveeta', price:100,  cat:'Extras' },
  { id:'extra_salsita',   name:'Extra Salsita de Ajo y Perejil', price:50,   cat:'Extras' },
  { id:'extra_mayo',      name:'Extra Ellys Mayo',              price:50,   cat:'Extras' }
];

// â”€â”€ Estado global â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let soldOutSet      = new Set();   // IDs actualmente agotados
let lastOrderCount  = 0;
let hasInteracted   = false;       // reemplaza hasPlayedSound

// â”€â”€ AudioContext (mismo patrÃ³n que index.html) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx = null;
function ensureAudioContext() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}
['click','touchstart'].forEach(e => document.addEventListener(e, ensureAudioContext, { once: true }));

function playBeeps(freqs, volume = 0.4) {
  try {
    if (!audioCtx) return;
    ensureAudioContext();
    const now = audioCtx.currentTime;
    freqs.forEach((freq, i) => {
      const osc  = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(volume, now + i * 0.18);
      gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.18 + 0.15);
      osc.start(now + i * 0.18);
      osc.stop(now  + i * 0.18 + 0.16);
    });
  } catch (e) { /* silente */ }
}

// Nueva orden: 3 beeps ascendentes rÃ¡pidos
function playNewOrderSound()   { playBeeps([660, 880, 1100]); }
// ConfirmaciÃ³n (aceptar / marcar lista): 2 beeps suaves
function playConfirmSound()    { playBeeps([440, 660], 0.3); }

// â”€â”€ Utilidades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(msg) {
  document.getElementById("error-message").innerHTML = `<div class="error">âŒ ${msg}</div>`;
}
function clearError() {
  document.getElementById("error-message").innerHTML = '';
}

function updateStats(orders) {
  document.getElementById('total-orders').textContent     = orders.length;
  document.getElementById('pending-orders').textContent   = orders.filter(o => o.status === 'pending' || !o.status).length;
  document.getElementById('preparing-orders').textContent = orders.filter(o => o.status === 'accepted').length;
  document.getElementById('ready-orders').textContent     = orders.filter(o => o.status === 'ready').length;
}

// â”€â”€ Notificaciones de navegador â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function requestNotificationPermission() {
  if (!("Notification" in window)) { alert("Tu navegador no soporta notificaciones"); return; }
  try {
    const perm = await Notification.requestPermission();
    if (perm === "granted") {
      document.getElementById('notification-banner').classList.remove('show');
      new Notification("Â¡Notificaciones Habilitadas!", {
        body: "Te avisaremos cuando lleguen nuevas Ã³rdenes a Pincer",
        icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸ””</text></svg>",
        tag: "pincer-notifications-enabled"
      });
    } else if (perm === "denied") {
      alert("âš ï¸ Has bloqueado las notificaciones.\n\n1. Click en el Ã­cono del candado ğŸ”’\n2. Busca 'Notificaciones'\n3. Cambia a 'Permitir'");
    }
  } catch (e) { console.error("requestNotificationPermission:", e); }
}

function sendNotification(title, body, tag) {
  try {
    if (typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
    const n = new Notification(title, {
      body,
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸ”</text></svg>",
      tag: tag || ('pincer-' + Date.now()),
      requireInteraction: true
    });
    n.onclick = function() { window.focus(); this.close(); };
  } catch (e) { /* silente */ }
}

// â”€â”€ PRODUCTOS: cargar + renderizar + togglear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProducts() {
  console.log("ğŸŸ¢ loadProducts iniciado");
  try {
    console.log("ğŸŸ¢ fetch products URL:", SUPABASE_URL + '/rest/v1/products?select=id,sold_out');
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/products?select=id,sold_out',
      { headers: sbGetHeaders() }
    );
    console.log("ğŸŸ¢ fetch products completado, status:", res.status);
    if (!res.ok) {
      // Tabla puede no existir aÃºn â†’ no es error fatal, renderizar todo disponible
      console.warn("âš ï¸ products table HTTP error " + res.status);
      soldOutSet = new Set();
      renderProducts();
      return;
    }
    const rows = await res.json();
    soldOutSet = new Set(rows.filter(r => r.sold_out).map(r => r.id));
    console.log("âœ… Productos cargados, agotados:", [...soldOutSet]);
  } catch (e) {
    console.warn("âš ï¸ loadProducts catch:", e.name, e.message);
    soldOutSet = new Set();
  }
  renderProducts();
}

function renderProducts() {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';

  MENU_DATA.forEach(item => {
    const isSoldOut = soldOutSet.has(item.id);

    const card = document.createElement('div');
    card.className = 'product-card' + (isSoldOut ? ' is-soldout' : '');
    card.id = 'prodCard_' + item.id;
    card.innerHTML = `
      <div class="product-card-top">
        <div>
          <div class="product-card-name">${item.name}</div>
          <div class="product-card-price">RD$${item.price.toLocaleString()}</div>
        </div>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">${isSoldOut ? 'Agotado' : 'Disponible'}</span>
        <label class="toggle-switch">
          <input type="checkbox" ${isSoldOut ? 'checked' : ''} onchange="toggleSoldOut('${item.id}', this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>`;
    grid.appendChild(card);
  });
}

async function toggleSoldOut(productId, isSoldOut) {
  // Optimistic update inmediato
  if (isSoldOut) soldOutSet.add(productId); else soldOutSet.delete(productId);
  updateProductCardUI(productId, isSoldOut);

  try {
    // UPSERT: si existe actualiza, si no existe lo inserta
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/products',
      {
        method: 'POST',
        headers: sbWriteHeaders({ 'Prefer': 'resolution=merge-duplicates' }),
        body: JSON.stringify({ id: productId, sold_out: isSoldOut })
      }
    );
    if (!res.ok) {
      const txt = await res.text();
      console.error("âŒ toggleSoldOut upsert â†’", res.status, txt);
      // Revertir si fallÃ³
      if (isSoldOut) soldOutSet.delete(productId); else soldOutSet.add(productId);
      updateProductCardUI(productId, !isSoldOut);
      showError("No se pudo actualizar el producto. Verifica la conexiÃ³n.");
      return;
    }
    console.log("âœ… Producto", productId, "â†’ sold_out:", isSoldOut);
    clearError();
  } catch (e) {
    console.error("âŒ toggleSoldOut:", e.message);
    // Revertir
    if (isSoldOut) soldOutSet.delete(productId); else soldOutSet.add(productId);
    updateProductCardUI(productId, !isSoldOut);
    showError("Error de conexiÃ³n al actualizar producto.");
  }
}

function updateProductCardUI(productId, isSoldOut) {
  const card  = document.getElementById('prodCard_' + productId);
  if (!card) return;
  const label = card.querySelector('.toggle-label');
  const chk   = card.querySelector('input[type=checkbox]');

  card.classList.toggle('is-soldout', isSoldOut);
  label.textContent = isSoldOut ? 'Agotado' : 'Disponible';
  chk.checked       = isSoldOut;
}

// â”€â”€ Ã“RDENES: cargar + renderizar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders() {
  console.log("ğŸ”µ loadOrders iniciado");
  try {
    console.log("ğŸ”µ fetch orders URL:", SUPABASE_URL + '/rest/v1/orders?select=*&order=created_at.desc');
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/orders?select=*&order=created_at.desc',
      { headers: sbGetHeaders() }
    );
    console.log("ğŸ”µ fetch orders completado, status:", res.status);
    if (!res.ok) {
      console.error("âŒ loadOrders HTTP error", res.status);
      showError("Error al cargar Ã³rdenes (HTTP " + res.status + ")");
      document.getElementById("connection-status").innerHTML = "ğŸ”´ Desconectado";
      return;
    }
    const data = await res.json();

    document.getElementById("connection-status").innerHTML = "ğŸŸ¢ Conectado";

    const container = document.getElementById("orders");

    if (!data || data.length === 0) {
      container.innerHTML = "<div class='loading'>âœ… No hay Ã³rdenes pendientes</div>";
      updateStats([]);
      lastOrderCount = 0;
      hasInteracted  = true;
      return;
    }

    updateStats(data);

    // â”€â”€ Detectar nueva orden â”€â”€
    const currentPending = data.filter(o => o.status === 'pending' || !o.status).length;

    if (hasInteracted && currentPending > lastOrderCount) {
      console.log("ğŸ”” Nueva orden detectada");
      playNewOrderSound();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
      sendNotification(
        "Â¡Nueva orden en Pincer!",
        `Tienes ${currentPending} orden(es) pendiente(s)`
      );
    }

    lastOrderCount = currentPending;
    hasInteracted  = true;

    // â”€â”€ Renderizar Ã³rdenes â”€â”€
    container.innerHTML = '';

    data.forEach(order => {
      const createdAt = new Date(order.created_at);
      const minutes   = Math.floor((Date.now() - createdAt.getTime()) / 60000);
      const status    = order.status || 'pending';

      let statusClass = 'new';
      if      (status === 'ready')    statusClass = 'ready';
      else if (status === 'accepted') statusClass = 'accepted';
      else if (minutes > 5)           statusClass = 'late';
      else if (minutes > 2)           statusClass = 'warning';

      let statusBadgeClass, statusText;
      if      (status === 'ready')    { statusBadgeClass = 'status-ready';    statusText = 'âœ“ LISTA PARA RETIRAR'; }
      else if (status === 'accepted') { statusBadgeClass = 'status-accepted'; statusText = 'ğŸ‘¨â€ğŸ³ EN PREPARACIÃ“N'; }
      else                            { statusBadgeClass = 'status-pending';  statusText = 'â³ PENDIENTE'; }

      const div = document.createElement("div");
      div.className = `order ${statusClass}`;
      div.innerHTML = `
        <div class="order-number">#${order.id}</div>
        <span class="order-status ${statusBadgeClass}">${statusText}</span>
        <div class="order-items"><strong>ğŸ“‹ Items:</strong> ${order.items || 'Sin especificar'}</div>
        <div class="order-time">â±ï¸ Hace ${minutes} minuto${minutes !== 1 ? 's' : ''}</div>
        <br>
        ${status === 'pending'  ? `<button class="btn-accept" onclick="acceptOrder(${order.id})">âœ… Marcar como digitada</button>` : ''}
        ${status === 'accepted' ? `<button class="btn-ready"  onclick="markReady(${order.id})">ğŸ‰ Marcar como LISTA</button>`  : ''}
        ${status === 'ready'    ? `<span class="completed-badge">âœ“ COMPLETADA - Cliente notificado</span>` : ''}`;
      container.appendChild(div);
    });

    clearError();
  } catch (err) {
    console.error("âŒ loadOrders catch:", err.name, err.message);
    showError("Error inesperado: " + err.message);
    document.getElementById("connection-status").innerHTML = "ğŸ”´ Error de conexiÃ³n";
  }
}

// â”€â”€ Aceptar orden (pending â†’ accepted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function acceptOrder(id) {
  try {
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/orders?id=eq.' + id,
      {
        method: 'PATCH',
        headers: sbWriteHeaders(),
        body: JSON.stringify({ status: 'accepted' })
      }
    );
    if (!res.ok) {
      showError("Error al marcar orden #" + id);
      return;
    }
    console.log("âœ… Orden #" + id + " â†’ accepted");
    playConfirmSound();
    setTimeout(loadOrders, 150);
  } catch (e) {
    console.error("acceptOrder:", e);
    showError("Error inesperado al aceptar orden.");
  }
}

// â”€â”€ Marcar lista (accepted â†’ ready) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function markReady(id) {
  try {
    const res = await fetchWithTimeout(
      SUPABASE_URL + '/rest/v1/orders?id=eq.' + id,
      {
        method: 'PATCH',
        headers: sbWriteHeaders(),
        body: JSON.stringify({ status: 'ready' })
      }
    );
    if (!res.ok) {
      showError("Error al marcar orden #" + id + " como lista");
      return;
    }
    console.log("âœ… Orden #" + id + " â†’ ready");
    playConfirmSound();
    setTimeout(loadOrders, 150);
  } catch (e) {
    console.error("markReady:", e);
    showError("Error inesperado al marcar como lista.");
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Catch global de errores
window.addEventListener('error', (e) => {
  console.error('âŒ Error global:', e.message, e.filename, e.lineno);
  document.getElementById("connection-status").innerHTML = "ğŸ”´ Error: " + e.message;
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('âŒ Promise sin catch:', e.reason);
  document.getElementById("connection-status").innerHTML = "ğŸ”´ Promise error";
});

document.addEventListener('DOMContentLoaded', () => {
  console.log("ğŸš€ Iniciando Pincer Dashboard...");
  console.log("ğŸš€ SUPABASE_URL:", SUPABASE_URL);
  console.log("ğŸš€ User agent:", navigator.userAgent);

  // Notificaciones
  if ("Notification" in window) {
    if      (Notification.permission === "default") document.getElementById('notification-banner').classList.add('show');
    else if (Notification.permission === "granted") {
      new Notification("Pincer Dashboard Iniciado", {
        body: "Dashboard activo. Te notificaremos de nuevas Ã³rdenes.",
        icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸ“Ÿ</text></svg>",
        tag: "pincer-dashboard-ready"
      });
    } else if (Notification.permission === "denied") {
      showError("Las notificaciones estÃ¡n bloqueadas. Click en el candado ğŸ”’ para habilitarlas.");
    }
  }

  // Cargar productos y Ã³rdenes
  loadProducts();
  loadOrders();

  // Polling de Ã³rdenes cada 3s â€” tambiÃ©n actualiza productos cada 30s
  setInterval(loadOrders, 3000);
  setInterval(loadProducts, 30000);

  // Primer click â†’ habilita audio
  document.addEventListener('click', () => { hasInteracted = true; ensureAudioContext(); }, { once: true });

  console.log("âœ… Pincer Dashboard configurado");
});
</script>
</body>
</html>
