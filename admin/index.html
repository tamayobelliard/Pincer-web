<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pincer Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f1f5f9; color: #1e293b; }

    /* Login */
    .login-screen {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    .login-card {
      background: white; padding: 40px; border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
    }
    .login-card h1 { text-align: center; color: #4338ca; margin-bottom: 10px; font-size: 2em; }
    .login-card p { text-align: center; color: #64748b; margin-bottom: 30px; }
    .login-error {
      display: none; background: #fee2e2; color: #991b1b;
      padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600;
    }
    .login-card label { display: block; color: #475569; font-weight: 600; margin-bottom: 8px; }
    .login-card input[type="text"], .login-card input[type="password"] {
      width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; margin-bottom: 20px;
    }
    .login-card button {
      width: 100%; padding: 15px;
      background: linear-gradient(135deg, #4338ca, #6366f1); color: white;
      border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer;
    }
    .login-card button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Header */
    .header {
      background: linear-gradient(135deg, #4338ca, #6366f1);
      color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;
    }
    .header h1 { font-size: 1.5em; }
    .header button {
      background: rgba(255,255,255,0.2); color: white; border: none;
      padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }

    /* Main */
    .main { max-width: 960px; margin: 0 auto; padding: 30px 20px; }

    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 30px; }
    .stat-card {
      background: white; border-radius: 14px; padding: 20px; text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .stat-card .number { font-size: 2.2em; font-weight: 800; color: #4338ca; }
    .stat-card .label { color: #64748b; font-size: 0.9em; margin-top: 4px; }

    /* Section header */
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .section-header h2 { font-size: 1.3em; }
    .btn-primary {
      background: linear-gradient(135deg, #4338ca, #6366f1); color: white;
      border: none; padding: 12px 24px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.95em;
    }
    .btn-danger {
      background: #dc2626; color: white; border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em;
    }
    .btn-danger:hover { background: #b91c1c; }

    /* Restaurant cards */
    .restaurant-list { display: flex; flex-direction: column; gap: 14px; }
    .restaurant-card {
      background: white; border-radius: 14px; padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex; justify-content: space-between; align-items: center;
    }
    .restaurant-info h3 { font-size: 1.1em; margin-bottom: 4px; }
    .restaurant-info .meta { color: #64748b; font-size: 0.85em; }
    .restaurant-actions { display: flex; gap: 10px; align-items: center; }
    .badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 0.8em; font-weight: 700; text-transform: uppercase;
    }
    .badge-active { background: #dcfce7; color: #166534; }
    .badge-pending { background: #fef9c3; color: #854d0e; }
    .badge-disabled { background: #fee2e2; color: #991b1b; }
    .btn-toggle {
      background: #f1f5f9; border: 1px solid #e2e8f0; padding: 8px 16px;
      border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600;
    }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 9999; align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%;
      max-height: 90vh; overflow-y: auto;
    }
    .modal h2 { margin-bottom: 20px; color: #4338ca; }
    .modal label { display: block; color: #475569; font-weight: 600; margin-bottom: 6px; font-size: 0.9em; }
    .modal input, .modal textarea, .modal select {
      width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 0.95em; margin-bottom: 14px; font-family: inherit; background: white;
    }

    /* Schedule builder */
    .schedule-builder { margin-bottom: 14px; }
    .day-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .day-chip {
      padding: 6px 12px; border-radius: 20px; border: 2px solid #e2e8f0;
      font-size: 0.8em; font-weight: 700; cursor: pointer; user-select: none;
      background: white; color: #64748b; transition: all 0.15s;
    }
    .day-chip.active { background: #4338ca; color: white; border-color: #4338ca; }
    .time-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .time-row select { width: auto; flex: 1; margin-bottom: 0; padding: 8px; font-size: 0.85em; }
    .time-row span { color: #64748b; font-size: 0.85em; font-weight: 600; white-space: nowrap; }
    .btn-apply-all {
      background: #f0f0ff; border: 1px solid #c7d2fe; color: #4338ca;
      padding: 6px 14px; border-radius: 6px; font-size: 0.8em; font-weight: 700;
      cursor: pointer; transition: all 0.15s;
    }
    .btn-apply-all:hover { background: #e0e7ff; }
    .schedule-preview {
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
      padding: 10px 14px; font-size: 0.85em; color: #475569; min-height: 20px;
    }
    .modal textarea { resize: vertical; min-height: 60px; }
    .modal-buttons { display: flex; gap: 12px; margin-top: 10px; }
    .modal-buttons button { flex: 1; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.95em; }
    .btn-cancel { background: #f1f5f9; border: 1px solid #e2e8f0; color: #475569; }
    .btn-submit { background: linear-gradient(135deg, #4338ca, #6366f1); color: white; border: none; }

    /* Credentials result */
    .credentials-box {
      background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px;
      padding: 20px; margin-top: 16px; text-align: center;
    }
    .credentials-box h3 { color: #166534; margin-bottom: 12px; }
    .credentials-box .cred { font-family: monospace; font-size: 1.1em; background: white; padding: 8px 16px; border-radius: 8px; display: inline-block; margin: 4px; }

    .empty-state { text-align: center; padding: 40px; color: #94a3b8; }

    /* Edit button */
    .btn-edit {
      background: #f0f0ff; border: 1px solid #c7d2fe; color: #4338ca;
      padding: 8px 16px; border-radius: 8px; cursor: pointer;
      font-size: 0.85em; font-weight: 600; transition: all 0.15s;
    }
    .btn-edit:hover { background: #e0e7ff; }

    /* Menu upload */
    .menu-upload-section {
      margin-top: 10px; margin-bottom: 14px;
      padding: 16px; border: 2px dashed #e2e8f0; border-radius: 12px;
      text-align: center; background: #f8fafc;
    }
    .menu-upload-section.disabled { opacity: 0.5; pointer-events: none; }
    .btn-upload-menu {
      background: linear-gradient(135deg, #059669, #10b981); color: white;
      border: none; padding: 10px 20px; border-radius: 8px;
      font-weight: 700; cursor: pointer; font-size: 0.9em;
    }
    .btn-upload-menu:disabled { background: #94a3b8; cursor: not-allowed; }
    .menu-upload-loading { display: none; padding: 20px; text-align: center; color: #64748b; }
    .menu-upload-loading.active { display: block; }
    .spinner {
      display: inline-block; width: 24px; height: 24px;
      border: 3px solid #e2e8f0; border-top-color: #4338ca;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Menu preview */
    .menu-preview { max-height: 300px; overflow-y: auto; }
    .menu-preview-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 14px; background: white; border: 1px solid #e2e8f0;
      border-radius: 8px; margin-bottom: 6px; font-size: 0.9em;
    }
    .menu-preview-item .item-name { font-weight: 600; color: #1e293b; }
    .menu-preview-item .item-price { color: #4338ca; font-weight: 700; }
    .menu-preview-item .item-category {
      font-size: 0.75em; background: #f1f5f9; color: #64748b;
      padding: 2px 8px; border-radius: 10px; text-transform: uppercase; font-weight: 700;
    }
    .menu-preview-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    .menu-preview-header h4 { color: #166534; margin: 0; }
    .menu-preview-count {
      background: #dcfce7; color: #166534; padding: 4px 10px;
      border-radius: 12px; font-size: 0.8em; font-weight: 700;
    }

    /* URL extraction */
    .url-extract-section {
      display: flex; gap: 8px; margin-bottom: 12px;
    }
    .url-extract-section input {
      flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 0.9em; margin-bottom: 0;
    }
    .btn-extract-url {
      background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white;
      border: none; padding: 10px 16px; border-radius: 8px;
      font-weight: 700; cursor: pointer; font-size: 0.85em; white-space: nowrap;
    }
    .btn-extract-url:disabled { background: #94a3b8; cursor: not-allowed; }
    .menu-preview-group-header {
      font-size: 0.85em; font-weight: 700; color: #4338ca; text-transform: uppercase;
      letter-spacing: 0.5px; margin: 10px 0 6px 0; padding-bottom: 4px;
      border-bottom: 2px solid #e0e7ff;
    }

    /* Tooltip */
    .tooltip-wrapper { position: relative; display: inline-block; }
    .tooltip-wrapper .tooltip-text {
      visibility: hidden; background: #1e293b; color: white;
      font-size: 0.8em; padding: 6px 12px; border-radius: 6px;
      position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
      white-space: nowrap; z-index: 1;
    }
    .tooltip-wrapper:hover .tooltip-text { visibility: visible; }

    /* Current hours in edit mode */
    .current-hours {
      background: #fef9c3; border: 1px solid #fde68a; border-radius: 8px;
      padding: 8px 14px; font-size: 0.85em; color: #854d0e; margin-bottom: 8px;
    }

    @media (max-width: 600px) {
      .stats-row { grid-template-columns: 1fr; }
      .restaurant-card { flex-direction: column; align-items: flex-start; gap: 12px; }
      .restaurant-actions { width: 100%; justify-content: space-between; }
    }

    /* QR button on cards */
    .btn-qr {
      background: #f0f0ff; border: 1px solid #c7d2fe; color: #4338ca;
      padding: 8px 16px; border-radius: 8px; cursor: pointer;
      font-size: 0.85em; font-weight: 600; transition: all 0.15s;
    }
    .btn-qr:hover { background: #e0e7ff; }

    /* QR modal content */
    .qr-modal-content { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .qr-modal-content #qrCodeContainer { padding: 16px; background: white; border-radius: 12px; border: 2px solid #e2e8f0; }
    .qr-url-text { color: #64748b; font-size: 0.85em; word-break: break-all; text-align: center; margin: 0; }
    .qr-actions { display: flex; gap: 12px; width: 100%; }
    .qr-actions button { flex: 1; }

    /* Print template (hidden on screen) */
    #qrPrintArea { display: none; }

    @page { margin: 0; }
    @media print {
      html, body { margin: 0 !important; padding: 0 !important; }
      body > *:not(#qrPrintArea) { display: none !important; }
      .modal-overlay { display: none !important; }
      #qrPrintArea {
        display: flex !important; flex-direction: column;
        width: 100%; min-height: 100vh;
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
      }
      /* Header: restaurant-branded background with logo + name */
      #qrPrintArea .print-header {
        color: white !important;
        text-align: center; padding: 32px 20px;
        display: flex; flex-direction: column; align-items: center; gap: 14px;
      }
      #qrPrintArea .print-logo-circle {
        width: 120px; height: 120px; border-radius: 50%;
        background: white !important; padding: 8px;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
      }
      #qrPrintArea .print-logo { width: 100%; height: 100%; object-fit: contain; }
      #qrPrintArea .print-name { font-size: 22px; font-weight: 800; color: white; }
      /* Middle: white background with QR + CTA */
      #qrPrintArea .print-middle {
        flex: 1; background: white; position: relative;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 32px 20px; gap: 20px; text-align: center;
      }
      #qrPrintArea .print-qr canvas { width: 220px !important; height: 220px !important; }
      #qrPrintArea .print-cta-1 { font-size: 22px; font-weight: 800; color: #1a2332; margin: 0; }
      #qrPrintArea .print-cta-2 { font-size: 28px; font-weight: 800; color: #1a2332; margin: 4px 0 0 0; }
      #qrPrintArea .print-watermark {
        position: absolute; bottom: 12px; right: 16px;
        width: 40px; height: 40px; opacity: 0.7;
      }
      /* Footer: dark Pincer branding */
      #qrPrintArea .print-footer {
        width: 100%; padding: 24px 20px;
        background: #1a2332 !important; color: white !important;
        text-align: center;
      }
      #qrPrintArea .print-footer-logo { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
      #qrPrintArea .print-footer-logo img { height: 28px; }
      #qrPrintArea .print-footer-logo span { font-size: 20px; font-weight: 800; color: white; }
      #qrPrintArea .print-footer p { font-size: 12px; color: rgba(255,255,255,0.7); margin: 4px 0; }
      #qrPrintArea .print-footer-badges { display: flex; align-items: center; justify-content: center; gap: 16px; margin: 12px 0; }
      #qrPrintArea .print-footer-badges img { height: 32px; object-fit: contain; }
      #qrPrintArea .print-footer-copyright { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 8px; }
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <h1>ğŸ”’ Pincer Admin</h1>
    <p>Panel de administraciÃ³n</p>
    <div class="login-error" id="loginError"></div>
    <form id="loginForm">
      <label>Usuario</label>
      <input type="text" id="username" required placeholder="admin">
      <label>ContraseÃ±a</label>
      <input type="password" id="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      <button type="submit" id="loginBtn">Iniciar SesiÃ³n</button>
    </form>
  </div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" style="display:none;">
  <div class="header">
    <h1>ğŸ”’ Pincer Admin</h1>
    <button onclick="logout()">Cerrar SesiÃ³n</button>
  </div>

  <div class="main">
    <div class="stats-row">
      <div class="stat-card">
        <div class="number" id="statTotal">-</div>
        <div class="label">Total Restaurantes</div>
      </div>
      <div class="stat-card">
        <div class="number" id="statActive">-</div>
        <div class="label">Activos</div>
      </div>
      <div class="stat-card">
        <div class="number" id="statPending">-</div>
        <div class="label">Pendientes</div>
      </div>
    </div>

    <div class="section-header">
      <h2>Restaurantes</h2>
      <button class="btn-primary" onclick="openNewModal()">+ Nuevo Cliente</button>
    </div>

    <div class="restaurant-list" id="restaurantList">
      <div class="empty-state">Cargando...</div>
    </div>
  </div>
</div>

<!-- Restaurant Modal (Create / Edit) -->
<div class="modal-overlay" id="newModal">
  <div class="modal">
    <h2 id="modalTitle">Nuevo Cliente</h2>
    <div id="modalForm">
      <label>Nombre del negocio *</label>
      <input type="text" id="fieldName" placeholder="Ej: La Cocina de MarÃ­a">
      <label>Tipo de negocio</label>
      <select id="fieldType">
        <option value="">Seleccionar...</option>
        <option value="Restaurante">Restaurante</option>
        <option value="CafeterÃ­a">CafeterÃ­a</option>
        <option value="Bar">Bar</option>
        <option value="Food Truck">Food Truck</option>
        <option value="Food Court">Food Court</option>
        <option value="PanaderÃ­a">PanaderÃ­a</option>
        <option value="Otro">Otro</option>
      </select>
      <label>DirecciÃ³n</label>
      <input type="text" id="fieldAddress" placeholder="Calle, sector, ciudad">
      <label>TelÃ©fono</label>
      <input type="text" id="fieldPhone" placeholder="809-000-0000">
      <label>Persona de contacto</label>
      <input type="text" id="fieldContact" placeholder="Nombre del dueÃ±o/encargado">
      <label>Email</label>
      <input type="text" id="fieldEmail" placeholder="correo@ejemplo.com">
      <label>Horario</label>
      <div id="currentHoursDisplay" class="current-hours" style="display:none;"></div>
      <div class="schedule-builder">
        <div class="day-chips" id="dayChips"></div>
        <div class="time-row">
          <span>Abre</span>
          <select id="timeOpen"></select>
          <span>Cierra</span>
          <select id="timeClose"></select>
          <button type="button" class="btn-apply-all" onclick="applyToSelected()">Aplicar</button>
        </div>
        <div class="schedule-preview" id="schedulePreview">Selecciona dÃ­as y horario</div>
      </div>
      <label>Website / Instagram</label>
      <input type="text" id="fieldWebsite" placeholder="@instagram o www...">
      <label>Notas</label>
      <textarea id="fieldNotes" placeholder="Notas adicionales..."></textarea>
      <label>Logo del negocio (URL)</label>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:18px;">
        <input type="text" id="fieldLogoUrl" placeholder="https://i.imgur.com/..." style="margin-bottom:0;flex:1;" oninput="previewLogo()">
        <div id="logoPreview" style="width:48px;height:48px;border-radius:50%;border:2px solid #e2e8f0;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:#f8fafc;">
          <span style="color:#94a3b8;font-size:0.7em;">Logo</span>
        </div>
      </div>
      <label>Personalidad del Chatbot</label>
      <select id="fieldPersonality">
        <option value="casual">Casual y amigable (neutro)</option>
        <option value="dominicano">Dominicano autÃ©ntico</option>
        <option value="habibi">Ãrabe caribeÃ±o (habibi)</option>
        <option value="formal">Profesional y formal</option>
        <option value="playful">Divertido y juguetÃ³n</option>
      </select>

      <!-- Menu Upload: URL + Photo modes -->
      <div id="menuUploadSection" class="menu-upload-section disabled">
        <div id="menuUploadIdle">
          <!-- Option 1: URL extraction -->
          <p style="color:#475569;font-size:0.85em;font-weight:600;margin-bottom:6px;">Extraer desde URL</p>
          <div class="url-extract-section">
            <input type="text" id="menuUrlInput" placeholder="https://menu.ejemplo.com/...">
            <button type="button" class="btn-extract-url" id="btnExtractUrl" onclick="extractFromUrl()">Extraer</button>
          </div>
          <div style="border-top:1px solid #e2e8f0;margin:12px 0;"></div>
          <!-- Option 2: Photo upload -->
          <p style="color:#475569;font-size:0.85em;font-weight:600;margin-bottom:6px;">Subir Foto de MenÃº</p>
          <div id="menuGroupSelector" style="display:none;margin-bottom:8px;">
            <label style="font-size:0.8em;color:#64748b;">Grupo de menÃº:</label>
            <select id="menuGroupSelect" style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.85em;margin-top:4px;">
              <option value="">Sin grupo</option>
            </select>
          </div>
          <div class="tooltip-wrapper">
            <button type="button" class="btn-upload-menu" id="btnUploadMenu" disabled onclick="triggerMenuUpload()">Subir Foto</button>
            <span class="tooltip-text" id="uploadTooltip">Guarda el cliente primero</span>
          </div>
          <p style="color:#94a3b8;font-size:0.8em;margin-top:8px;">JPG, PNG o WebP</p>
        </div>
        <div class="menu-upload-loading" id="menuUploadLoading">
          <div class="spinner"></div>
          <p style="margin-top:10px;">Procesando menÃº con IA...</p>
        </div>
        <div id="menuPreviewContainer" style="display:none;"></div>
      </div>
      <input type="file" id="menuFileInput" accept="image/jpeg,image/png,image/webp" style="display:none;" onchange="handleMenuFile(event)">

      <!-- Password Reset (edit mode only) -->
      <div id="passwordResetSection" style="display:none; border-top:1px solid #e2e8f0; margin:20px 0 0 0; padding-top:16px;">
        <button type="button" class="btn-danger" onclick="resetPassword()">ğŸ”‘ Resetear ContraseÃ±a</button>
        <div id="passwordResetResult" style="display:none;"></div>
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
        <button class="btn-submit" id="submitBtn" onclick="handleSubmit()">Crear Cliente</button>
      </div>
    </div>
    <div id="modalResult" style="display:none;"></div>
  </div>
</div>

<!-- QR Code Modal -->
<div class="modal-overlay" id="qrModal">
  <div class="modal" style="max-width:520px;">
    <h2 id="qrModalTitle">CÃ³digo QR</h2>
    <div class="qr-modal-content">
      <div id="qrCodeContainer"></div>
      <p class="qr-url-text" id="qrUrl"></p>
      <div class="qr-actions">
        <button class="btn-primary" onclick="downloadQR()">Descargar QR</button>
        <button class="btn-edit" onclick="printQR()">Imprimir QR</button>
      </div>
    </div>
    <button class="btn-toggle" onclick="closeQrModal()" style="margin-top:16px;width:100%;">Cerrar</button>
  </div>
</div>

<!-- QR Print Template (hidden on screen, visible on print) -->
<div id="qrPrintArea">
  <div class="print-header" id="printHeader">
    <div class="print-logo-circle" id="printLogoCircle">
      <img id="printLogo" class="print-logo" src="" alt="">
    </div>
    <div id="printName" class="print-name"></div>
  </div>
  <div class="print-middle">
    <div id="printQrCode" class="print-qr"></div>
    <div class="print-cta-1">ORDENA Y PAGA DESDE TU CELULAR</div>
    <div class="print-cta-2">SIN FILAS</div>
    <img class="print-watermark" src="https://i.imgur.com/Dep2ZsJ.png" alt="">
  </div>
  <div class="print-footer">
    <div class="print-footer-logo">
      <img src="https://i.imgur.com/t72wYFc.png" alt="Pincer">
      <span>Pincer</span>
    </div>
    <p>Pedidos por QR que elevan la experiencia de tu restaurante, food truck o food park.</p>
    <p>info@pincerweb.com Â· +1(829) 548-1236 Â· Santiago, RepÃºblica Dominicana</p>
    <div class="print-footer-badges">
      <img src="https://i.imgur.com/gMRFXRj.png" alt="Visa">
      <img src="https://i.imgur.com/qgq4m7h.png" alt="Mastercard">
      <img src="https://i.imgur.com/fgA6bpW.png" alt="Visa Secure">
      <img src="https://i.imgur.com/KLv1a0r.png" alt="Mastercard ID Check">
    </div>
    <p class="print-footer-copyright">Â© 2026 Pincer. Hecho en RepÃºblica Dominicana.</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getSession() {
  try {
    const s = sessionStorage.getItem('dashboard_session');
    return s ? JSON.parse(s) : null;
  } catch { return null; }
}

// Helper: fetch with auto-logout on 403 (expired/invalid session token)
async function adminFetch(url, opts = {}) {
  const session = getSession();
  opts.headers = { ...opts.headers, 'x-admin-key': session?.adminToken || '' };
  const res = await fetch(url, opts);
  if (res.status === 403) {
    sessionStorage.removeItem('dashboard_session');
    location.reload();
    throw new Error('Session expired');
  }
  return res;
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  loginBtn.disabled = true;
  loginBtn.textContent = 'Verificando...';
  loginError.style.display = 'none';

  try {
    const res = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    const data = await res.json();

    if (data.success && data.role === 'admin') {
      sessionStorage.setItem('dashboard_session', JSON.stringify({
        role: data.role, username: data.username, display_name: data.display_name,
        adminToken: data.adminToken || '',
      }));
      showAdmin();
    } else if (data.success) {
      loginError.textContent = 'Acceso denegado. Solo administradores.';
      loginError.style.display = 'block';
    } else {
      loginError.textContent = data.error || 'Credenciales incorrectas';
      loginError.style.display = 'block';
    }
  } catch (err) {
    loginError.textContent = 'Error al conectar. Intenta de nuevo.';
    loginError.style.display = 'block';
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'Iniciar SesiÃ³n';
  }
});

function logout() {
  sessionStorage.removeItem('dashboard_session');
  location.reload();
}

function showAdmin() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('adminPanel').style.display = 'block';
  loadRestaurants();
}

// Check existing session on load
(function() {
  const session = getSession();
  if (session && session.role === 'admin') {
    showAdmin();
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD RESTAURANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let restaurants = [];
let modalMode = 'create';
let editingRestaurantId = null;
let editingRestaurantSlug = null;
let accumulatedItems = [];
let photoCount = 0;

async function loadRestaurants() {
  try {
    const res = await adminFetch('/api/admin?action=restaurants');
    if (!res.ok) throw new Error('Failed to load');
    restaurants = await res.json();
    renderRestaurants();
  } catch (err) {
    document.getElementById('restaurantList').innerHTML = '<div class="empty-state">Error al cargar restaurantes</div>';
  }
}

function renderRestaurants() {
  const list = document.getElementById('restaurantList');

  // Stats
  const total = restaurants.length;
  const active = restaurants.filter(r => r.status === 'active').length;
  const pending = restaurants.filter(r => r.status === 'pending').length;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statActive').textContent = active;
  document.getElementById('statPending').textContent = pending;

  if (total === 0) {
    list.innerHTML = '<div class="empty-state">No hay restaurantes registrados</div>';
    return;
  }

  list.innerHTML = restaurants.map(r => {
    const badgeClass = r.status === 'active' ? 'badge-active' : r.status === 'pending' ? 'badge-pending' : 'badge-disabled';
    const statusText = r.status === 'active' ? 'Activo' : r.status === 'pending' ? 'Pendiente' : 'Desactivado';
    const toggleText = r.status === 'active' ? 'Desactivar' : 'Activar';
    const date = new Date(r.created_at).toLocaleDateString('es-DO', { day: 'numeric', month: 'short', year: 'numeric' });

    return `
      <div class="restaurant-card">
        <div class="restaurant-info">
          <h3>${escapeHtml(r.display_name)}</h3>
          <div class="meta">@${escapeHtml(r.username)} Â· /${escapeHtml(r.restaurant_slug || '')} Â· ${date}</div>
        </div>
        <div class="restaurant-actions">
          <button class="btn-edit" onclick="openEditModal('${r.id}')">Editar</button>
          <button class="btn-edit" onclick="window.open('/${escapeHtml(r.restaurant_slug || '')}', '_blank')">Ver Men\u00fa</button>
          <button class="btn-edit" onclick="window.open('/${escapeHtml(r.restaurant_slug || '')}/dashboard', '_blank')">Dashboard</button>
          ${r.status === 'active' ? `<button class="btn-qr" onclick="showQR('${r.id}')">Ver QR</button>` : ''}
          <span class="badge ${badgeClass}">${statusText}</span>
          <button class="btn-toggle" onclick="toggleStatus('${r.id}', '${r.status}')">${toggleText}</button>
        </div>
      </div>
    `;
  }).join('');
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLE STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function toggleStatus(id, currentStatus) {
  const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
  try {
    const res = await adminFetch('/api/admin?action=restaurants', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, status: newStatus }),
    });
    if (res.ok) {
      loadRestaurants();
      // Auto-show QR when activating a restaurant
      if (newStatus === 'active') showQR(id);
    }
  } catch (err) {
    alert('Error al cambiar estado');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR CODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentQrRestaurant = null;

function showQR(id) {
  const r = restaurants.find(x => String(x.id) === String(id));
  if (!r) return;
  currentQrRestaurant = r;

  document.getElementById('qrModalTitle').textContent = r.display_name;

  const container = document.getElementById('qrCodeContainer');
  container.innerHTML = '';
  new QRCode(container, {
    text: 'https://pincerweb.com/' + (r.restaurant_slug || ''),
    width: 256,
    height: 256,
    colorDark: '#1e293b',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H,
  });

  document.getElementById('qrUrl').textContent = 'pincerweb.com/' + (r.restaurant_slug || '');
  document.getElementById('qrModal').classList.add('active');
}

function closeQrModal() {
  document.getElementById('qrModal').classList.remove('active');
}

function downloadQR() {
  setTimeout(function() {
    const canvas = document.querySelector('#qrCodeContainer canvas');
    if (!canvas) { alert('Error: QR no generado'); return; }
    const link = document.createElement('a');
    link.download = ((currentQrRestaurant && currentQrRestaurant.display_name) || 'QR') + '-QR.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  }, 100);
}

function printQR() {
  const r = currentQrRestaurant;
  if (!r) return;

  // Header background: use restaurant's menu_style.background_color or default dark
  const bgColor = (r.menu_style && r.menu_style.background_color) || '#1a2332';
  document.getElementById('printHeader').style.cssText = 'background:' + bgColor + ' !important;';

  // Logo in white circle
  const logoCircle = document.getElementById('printLogoCircle');
  const logo = document.getElementById('printLogo');
  if (r.logo_url) {
    logo.src = r.logo_url;
    logoCircle.style.display = '';
  } else {
    logoCircle.style.display = 'none';
  }

  document.getElementById('printName').textContent = r.display_name || '';

  // Clone QR canvas into print area
  const printQr = document.getElementById('printQrCode');
  printQr.innerHTML = '';
  const srcCanvas = document.querySelector('#qrCodeContainer canvas');
  if (srcCanvas) {
    const clone = document.createElement('canvas');
    clone.width = srcCanvas.width;
    clone.height = srcCanvas.height;
    clone.getContext('2d').drawImage(srcCanvas, 0, 0);
    printQr.appendChild(clone);
  }

  window.print();
}

// Close QR modal on overlay click
document.getElementById('qrModal').addEventListener('click', function(e) {
  if (e.target === e.currentTarget) closeQrModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW RESTAURANT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULE BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DAYS = [
  { key: 'lun', label: 'Lun' }, { key: 'mar', label: 'Mar' }, { key: 'mie', label: 'MiÃ©' },
  { key: 'jue', label: 'Jue' }, { key: 'vie', label: 'Vie' }, { key: 'sab', label: 'SÃ¡b' },
  { key: 'dom', label: 'Dom' },
];
const schedule = {}; // { lun: { open, close }, mar: ... }

function buildTimeOptions() {
  const opts = [];
  for (let h = 6; h <= 23; h++) {
    for (let m = 0; m < 60; m += 30) {
      const h12 = h > 12 ? h - 12 : h === 0 ? 12 : h;
      const ampm = h >= 12 ? 'PM' : 'AM';
      const label = `${h12}:${String(m).padStart(2, '0')} ${ampm}`;
      opts.push({ value: `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`, label });
    }
  }
  // Add 12:00 AM (midnight) as closing option
  opts.push({ value: '24:00', label: '12:00 AM' });
  return opts;
}

function initScheduleBuilder() {
  const chipsEl = document.getElementById('dayChips');
  chipsEl.innerHTML = DAYS.map(d =>
    `<div class="day-chip" data-day="${d.key}" onclick="toggleDay('${d.key}')">${d.label}</div>`
  ).join('');

  const timeOpts = buildTimeOptions();
  const openSel = document.getElementById('timeOpen');
  const closeSel = document.getElementById('timeClose');
  openSel.innerHTML = timeOpts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
  closeSel.innerHTML = timeOpts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
  // Defaults: 11:00 AM open, 10:00 PM close
  openSel.value = '11:00';
  closeSel.value = '22:00';
}

function toggleDay(day) {
  const chip = document.querySelector(`.day-chip[data-day="${day}"]`);
  chip.classList.toggle('active');
}

function applyToSelected() {
  const openVal = document.getElementById('timeOpen').value;
  const closeVal = document.getElementById('timeClose').value;
  const openLabel = document.getElementById('timeOpen').selectedOptions[0].text;
  const closeLabel = document.getElementById('timeClose').selectedOptions[0].text;

  document.querySelectorAll('.day-chip.active').forEach(chip => {
    const day = chip.dataset.day;
    schedule[day] = { open: openVal, close: closeVal, openLabel, closeLabel };
  });
  updatePreview();
}

function updatePreview() {
  const el = document.getElementById('schedulePreview');
  const assigned = DAYS.filter(d => schedule[d.key]);
  if (assigned.length === 0) { el.textContent = 'Selecciona dÃ­as y horario'; return; }

  // Group consecutive days with same hours
  const groups = [];
  let current = null;
  for (const d of DAYS) {
    const s = schedule[d.key];
    if (!s) { current = null; continue; }
    const sig = s.open + '-' + s.close;
    if (current && current.sig === sig && current.endIdx === DAYS.indexOf(d) - 1) {
      current.endIdx = DAYS.indexOf(d);
      current.days.push(d);
    } else {
      current = { sig, days: [d], endIdx: DAYS.indexOf(d), open: s.openLabel, close: s.closeLabel };
      groups.push(current);
    }
  }

  el.textContent = groups.map(g => {
    const dayStr = g.days.length === 1 ? g.days[0].label :
      g.days[0].label + '-' + g.days[g.days.length - 1].label;
    return `${dayStr} ${g.open} - ${g.close}`;
  }).join(', ');
}

function getScheduleText() {
  updatePreview();
  return document.getElementById('schedulePreview').textContent;
}

function resetSchedule() {
  Object.keys(schedule).forEach(k => delete schedule[k]);
  document.querySelectorAll('.day-chip').forEach(c => c.classList.remove('active'));
  document.getElementById('timeOpen').value = '11:00';
  document.getElementById('timeClose').value = '22:00';
  document.getElementById('schedulePreview').textContent = 'Selecciona dÃ­as y horario';
}

initScheduleBuilder();

function previewLogo() {
  const url = document.getElementById('fieldLogoUrl').value.trim();
  const preview = document.getElementById('logoPreview');
  if (url) {
    preview.innerHTML = '<img src="' + escapeHtml(url) + '" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML=\'<span style=color:#ef4444;font-size:0.6em>Error</span>\'">';
  } else {
    preview.innerHTML = '<span style="color:#94a3b8;font-size:0.7em;">Logo</span>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW RESTAURANT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openNewModal() {
  modalMode = 'create';
  editingRestaurantId = null;
  editingRestaurantSlug = null;

  document.getElementById('modalTitle').textContent = 'Nuevo Cliente';
  document.getElementById('submitBtn').textContent = 'Crear Cliente';
  document.getElementById('modalForm').style.display = 'block';
  document.getElementById('modalResult').style.display = 'none';
  document.getElementById('newModal').classList.add('active');

  ['fieldName','fieldAddress','fieldPhone','fieldContact','fieldEmail','fieldWebsite','fieldNotes']
    .forEach(id => { document.getElementById(id).value = ''; });
  document.getElementById('fieldType').value = '';
  document.getElementById('fieldPersonality').value = 'casual';
  document.getElementById('fieldLogoUrl').value = '';
  document.getElementById('logoPreview').innerHTML = '<span style="color:#94a3b8;font-size:0.7em;">Logo</span>';
  resetSchedule();

  document.getElementById('currentHoursDisplay').style.display = 'none';
  document.getElementById('menuUploadSection').classList.add('disabled');
  document.getElementById('btnUploadMenu').disabled = true;
  document.getElementById('uploadTooltip').style.display = '';
  resetMenuUpload();

  // Hide password reset in create mode
  document.getElementById('passwordResetSection').style.display = 'none';
  document.getElementById('passwordResetResult').style.display = 'none';
  document.getElementById('passwordResetResult').innerHTML = '';
}

function openEditModal(id) {
  const r = restaurants.find(x => String(x.id) === String(id));
  if (!r) return;

  modalMode = 'edit';
  editingRestaurantId = id;
  editingRestaurantSlug = r.restaurant_slug;

  document.getElementById('modalTitle').textContent = 'Editar Cliente';
  document.getElementById('submitBtn').textContent = 'Actualizar';
  document.getElementById('modalForm').style.display = 'block';
  document.getElementById('modalResult').style.display = 'none';
  document.getElementById('newModal').classList.add('active');

  // Pre-fill fields
  document.getElementById('fieldName').value = r.display_name || '';
  document.getElementById('fieldType').value = r.business_type || '';
  document.getElementById('fieldAddress').value = r.address || '';
  document.getElementById('fieldPhone').value = r.phone || '';
  document.getElementById('fieldContact').value = r.contact_name || '';
  document.getElementById('fieldEmail').value = r.email || '';
  document.getElementById('fieldWebsite').value = r.website || '';
  document.getElementById('fieldNotes').value = r.notes || '';
  document.getElementById('fieldPersonality').value = r.chatbot_personality || 'casual';
  document.getElementById('fieldLogoUrl').value = r.logo_url || '';
  previewLogo();

  // Schedule: show current hours, reset builder for optional overwrite
  resetSchedule();
  const hoursDisplay = document.getElementById('currentHoursDisplay');
  if (r.hours && r.hours !== 'Selecciona dÃ­as y horario') {
    hoursDisplay.textContent = 'Horario actual: ' + r.hours;
    hoursDisplay.style.display = 'block';
  } else {
    hoursDisplay.style.display = 'none';
  }

  // Menu upload: enabled (slug exists)
  document.getElementById('menuUploadSection').classList.remove('disabled');
  document.getElementById('btnUploadMenu').disabled = false;
  document.getElementById('uploadTooltip').style.display = 'none';
  resetMenuUpload();

  // Populate menu group selector if restaurant has menu_groups
  var groupSel = document.getElementById('menuGroupSelector');
  var groupSelect = document.getElementById('menuGroupSelect');
  if (r.menu_groups && Array.isArray(r.menu_groups) && r.menu_groups.length > 0) {
    groupSelect.innerHTML = '<option value="">Sin grupo</option>' +
      r.menu_groups.map(function(g) { return '<option value="' + escapeHtml(g.label) + '">' + escapeHtml(g.label) + '</option>'; }).join('');
    groupSel.style.display = 'block';
  } else {
    groupSel.style.display = 'none';
  }

  // Show password reset in edit mode
  document.getElementById('passwordResetSection').style.display = 'block';
  document.getElementById('passwordResetResult').style.display = 'none';
  document.getElementById('passwordResetResult').innerHTML = '';
}

function handleSubmit() {
  if (modalMode === 'edit') {
    updateRestaurant();
  } else {
    createRestaurant();
  }
}

function closeModal() {
  document.getElementById('newModal').classList.remove('active');
  modalMode = 'create';
  editingRestaurantId = null;
  editingRestaurantSlug = null;
  accumulatedItems = [];
  photoCount = 0;
  document.getElementById('passwordResetSection').style.display = 'none';
  document.getElementById('passwordResetResult').style.display = 'none';
  document.getElementById('passwordResetResult').innerHTML = '';
}

async function updateRestaurant() {
  const name = document.getElementById('fieldName').value.trim();
  if (!name) { alert('El nombre es requerido'); return; }

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Actualizando...';

  // Use schedule builder if admin changed it, otherwise don't send hours
  const scheduleText = getScheduleText();
  const r = restaurants.find(x => String(x.id) === String(editingRestaurantId));
  const useNewSchedule = scheduleText !== 'Selecciona dÃ­as y horario';

  // Only send fields that have actual values (don't overwrite existing data with nulls)
  const body = { id: editingRestaurantId, display_name: name };
  const optFields = {
    business_type: document.getElementById('fieldType').value.trim(),
    address: document.getElementById('fieldAddress').value.trim(),
    phone: document.getElementById('fieldPhone').value.trim(),
    contact_name: document.getElementById('fieldContact').value.trim(),
    email: document.getElementById('fieldEmail').value.trim(),
    website: document.getElementById('fieldWebsite').value.trim(),
    notes: document.getElementById('fieldNotes').value.trim(),
  };
  for (const [k, v] of Object.entries(optFields)) {
    if (v) body[k] = v;
  }
  if (useNewSchedule) body.hours = scheduleText;
  body.chatbot_personality = document.getElementById('fieldPersonality').value;
  body.logo_url = document.getElementById('fieldLogoUrl').value.trim();

  try {
    const res = await adminFetch('/api/admin?action=update', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();

    if (data.success) {
      closeModal();
      loadRestaurants();
    } else {
      alert(data.error || 'Error al actualizar cliente');
    }
  } catch (err) {
    alert('Error de conexiÃ³n');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Actualizar';
  }
}

async function resetPassword() {
  if (!editingRestaurantId) return;
  if (!confirm('Â¿Seguro que quieres resetear la contraseÃ±a de este cliente? La contraseÃ±a anterior dejarÃ¡ de funcionar.')) return;

  try {
    const res = await adminFetch('/api/admin?action=reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: editingRestaurantId })
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('passwordResetResult').style.display = 'block';
      document.getElementById('passwordResetResult').innerHTML = `
        <div class="credentials-box" style="margin-top:12px;">
          <strong>Nueva contraseÃ±a:</strong> <span class="cred">${escapeHtml(data.temp_password)}</span>
          <p style="color:#64748b;font-size:0.8em;margin-top:8px;">Copia esta contraseÃ±a ahora â€” no se mostrarÃ¡ de nuevo.</p>
        </div>`;
    } else {
      alert('Error: ' + (data.error || 'No se pudo resetear'));
    }
  } catch (e) {
    alert('Error de conexiÃ³n');
  }
}

async function createRestaurant() {
  const name = document.getElementById('fieldName').value.trim();
  if (!name) { alert('El nombre es requerido'); return; }

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Creando...';

  try {
    const res = await adminFetch('/api/admin?action=create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        business_type: document.getElementById('fieldType').value.trim(),
        address: document.getElementById('fieldAddress').value.trim(),
        phone: document.getElementById('fieldPhone').value.trim(),
        contact_name: document.getElementById('fieldContact').value.trim(),
        email: document.getElementById('fieldEmail').value.trim(),
        hours: getScheduleText(),
        website: document.getElementById('fieldWebsite').value.trim(),
        notes: document.getElementById('fieldNotes').value.trim(),
        chatbot_personality: document.getElementById('fieldPersonality').value,
        logo_url: document.getElementById('fieldLogoUrl').value.trim(),
      }),
    });
    const data = await res.json();

    if (data.success) {
      // Store slug for menu upload
      editingRestaurantSlug = data.username;

      document.getElementById('modalForm').style.display = 'none';
      document.getElementById('modalResult').style.display = 'block';
      document.getElementById('modalResult').innerHTML = `
        <div class="credentials-box">
          <h3>Cliente creado exitosamente</h3>
          <p style="margin-bottom:12px;color:#475569;">Comparte estas credenciales con el cliente:</p>
          <div><strong>Usuario:</strong> <span class="cred">${escapeHtml(data.username)}</span></div>
          <div style="margin-top:8px;"><strong>ContraseÃ±a:</strong> <span class="cred">${escapeHtml(data.temp_password)}</span></div>
          <p style="margin-top:16px;color:#64748b;font-size:0.85em;">${escapeHtml(data.display_name)} puede iniciar sesiÃ³n en pincerweb.com/${escapeHtml(data.username)}/dashboard</p>
        </div>
        <div class="menu-upload-section" style="margin-top:16px;">
          <div id="postCreateMenuIdle">
            <button type="button" class="btn-upload-menu" onclick="triggerMenuUpload()">Subir Foto de MenÃº</button>
            <p style="color:#94a3b8;font-size:0.8em;margin-top:8px;">JPG, PNG o WebP â€” Opcional</p>
          </div>
          <div class="menu-upload-loading" id="postCreateMenuLoading">
            <div class="spinner"></div>
            <p style="margin-top:10px;">Procesando menÃº con IA...</p>
          </div>
          <div id="postCreateMenuPreview" style="display:none;"></div>
        </div>
        <div class="modal-buttons" style="margin-top:16px;">
          <button class="btn-primary" onclick="closeModal()" style="width:100%;">Cerrar</button>
        </div>
      `;
      loadRestaurants();
    } else {
      alert(data.error || 'Error al crear cliente');
    }
  } catch (err) {
    alert('Error de conexiÃ³n');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Crear Cliente';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENU URL EXTRACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function extractFromUrl() {
  var urlInput = document.getElementById('menuUrlInput');
  var menuUrl = urlInput.value.trim();
  if (!menuUrl) { alert('Ingresa una URL'); return; }

  var slug = editingRestaurantSlug;
  if (!slug) { alert('Error: no se encontrÃ³ el slug del restaurante'); return; }

  showMenuLoading(true);

  try {
    var res = await adminFetch('/api/parse-menu', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: menuUrl, restaurant_slug: slug, mode: 'url' }),
    });
    var data = await res.json();

    if (data.success) {
      accumulatedItems = data.items;
      photoCount = 0;
      showMenuPreview(accumulatedItems, accumulatedItems.length, 0, false, data.menuGroups);

      // Update menu group selector if groups were detected
      if (data.menuGroups && Array.isArray(data.menuGroups) && data.menuGroups.length > 0) {
        var groupSel = document.getElementById('menuGroupSelector');
        var groupSelect = document.getElementById('menuGroupSelect');
        groupSelect.innerHTML = '<option value="">Sin grupo</option>' +
          data.menuGroups.map(function(g) { return '<option value="' + escapeHtml(g.label) + '">' + escapeHtml(g.label) + '</option>'; }).join('');
        groupSel.style.display = 'block';
      }
    } else {
      showMenuLoading(false);
      showUrlFallback();
    }
  } catch (err) {
    showMenuLoading(false);
    showUrlFallback();
  }
}

function showUrlFallback() {
  alert('No se pudo extraer el menÃº automÃ¡ticamente. El sitio puede ser dinÃ¡mico. Por favor sube fotos de cada secciÃ³n del menÃº.');
  document.getElementById('menuGroupSelector').style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENU PHOTO UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function triggerMenuUpload() {
  document.getElementById('menuFileInput').click();
}

function handleMenuFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
  if (!validTypes.includes(file.type)) {
    alert('Formato no soportado. Usa JPG, PNG o WebP.');
    return;
  }
  if (file.size > 10 * 1024 * 1024) {
    alert('La imagen es muy grande. MÃ¡ximo 10MB.');
    return;
  }

  event.target.value = '';

  // If file is over 1MB, resize to max 1200px width to reduce base64 payload
  if (file.size > 1 * 1024 * 1024) {
    const img = new Image();
    img.onload = function() {
      const MAX_W = 1200;
      let w = img.width, h = img.height;
      if (w > MAX_W) { h = Math.round(h * (MAX_W / w)); w = MAX_W; }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      uploadMenuPhoto(canvas.toDataURL('image/jpeg', 0.8));
    };
    img.src = URL.createObjectURL(file);
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) { uploadMenuPhoto(e.target.result); };
  reader.readAsDataURL(file);
}

async function uploadMenuPhoto(dataUri) {
  const slug = editingRestaurantSlug;
  if (!slug) { alert('Error: no se encontrÃ³ el slug del restaurante'); return; }

  showMenuLoading(true);

  try {
    var selectedGroup = document.getElementById('menuGroupSelect') ? document.getElementById('menuGroupSelect').value : '';
    var uploadMode = selectedGroup ? 'multi-photo' : 'photo';
    var payload = { image: dataUri, restaurant_slug: slug, start_order: accumulatedItems.length, mode: uploadMode };
    if (selectedGroup) payload.menu_group = selectedGroup;
    const res = await adminFetch('/api/parse-menu', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();

    if (data.success) {
      accumulatedItems = accumulatedItems.concat(data.items);
      photoCount++;
      showMenuPreview(accumulatedItems, accumulatedItems.length, photoCount, !!data.menuStyle);
    } else {
      alert((data.error || 'Error al procesar la imagen') + (data.details ? '\n\nDetalle: ' + data.details : ''));
      showMenuLoading(false);
    }
  } catch (err) {
    alert('Error de conexiÃ³n al procesar menÃº');
    showMenuLoading(false);
  }
}

function showMenuLoading(show) {
  // In-form context
  const formIdle = document.getElementById('menuUploadIdle');
  const formLoading = document.getElementById('menuUploadLoading');
  if (formIdle) formIdle.style.display = show ? 'none' : '';
  if (formLoading) formLoading.classList.toggle('active', show);

  // Post-create context
  const postIdle = document.getElementById('postCreateMenuIdle');
  const postLoading = document.getElementById('postCreateMenuLoading');
  if (postIdle) postIdle.style.display = show ? 'none' : '';
  if (postLoading) postLoading.classList.toggle('active', show);

  // Hide previews during loading
  if (show) {
    const fp = document.getElementById('menuPreviewContainer');
    const pp = document.getElementById('postCreateMenuPreview');
    if (fp) fp.style.display = 'none';
    if (pp) pp.style.display = 'none';
  }
}

function showMenuPreview(items, count, photos, styleSaved, detectedGroups) {
  showMenuLoading(false);

  var counterText = photos > 1
    ? count + ' items extraÃ­dos de ' + photos + ' fotos'
    : photos === 0
    ? count + ' items extraÃ­dos desde URL'
    : count + ' items extraÃ­dos';

  // Group items by menu_group for display
  var hasGroups = items.some(function(item) { return item.menu_group; });
  var itemsHtml = '';
  if (hasGroups) {
    var grouped = {};
    items.forEach(function(item) {
      var g = item.menu_group || 'Sin grupo';
      if (!grouped[g]) grouped[g] = [];
      grouped[g].push(item);
    });
    Object.keys(grouped).forEach(function(group) {
      itemsHtml += '<div class="menu-preview-group-header">' + escapeHtml(group) + '</div>';
      grouped[group].forEach(function(item) {
        itemsHtml += '<div class="menu-preview-item"><div><span class="item-name">' + escapeHtml(item.name) + '</span>' +
          (item.description ? '<br><span style="font-size:0.8em;color:#94a3b8;">' + escapeHtml(item.description) + '</span>' : '') +
          '</div><div style="display:flex;gap:8px;align-items:center;"><span class="item-category">' + escapeHtml(item.category) +
          '</span><span class="item-price">RD$' + item.price + '</span></div></div>';
      });
    });
  } else {
    items.forEach(function(item) {
      itemsHtml += '<div class="menu-preview-item"><div><span class="item-name">' + escapeHtml(item.name) + '</span>' +
        (item.description ? '<br><span style="font-size:0.8em;color:#94a3b8;">' + escapeHtml(item.description) + '</span>' : '') +
        '</div><div style="display:flex;gap:8px;align-items:center;"><span class="item-category">' + escapeHtml(item.category) +
        '</span><span class="item-price">RD$' + item.price + '</span></div></div>';
    });
  }

  var groupsInfo = detectedGroups ? '<span style="font-size:0.75em;color:#0ea5e9;">' + detectedGroups.length + ' grupo(s) detectado(s)</span>' : '';

  var previewHtml = '<div class="menu-preview-header"><h4>' + counterText + '</h4>' +
    (styleSaved ? '<span style="font-size:0.75em;color:#059669;">Estilo guardado</span>' : '') +
    groupsInfo + '</div>' +
    '<div class="menu-preview">' + itemsHtml + '</div>' +
    '<div style="display:flex;gap:10px;margin-top:10px;">' +
    '<button type="button" class="btn-upload-menu" style="flex:1;" onclick="triggerMenuUpload()">Subir Otra Foto</button>' +
    '<button type="button" class="btn-primary" style="flex:1;" onclick="confirmMenu()">Listo</button></div>';

  // Render in whichever container is visible
  const formContainer = document.getElementById('menuPreviewContainer');
  const postContainer = document.getElementById('postCreateMenuPreview');

  if (formContainer && document.getElementById('modalForm').style.display !== 'none') {
    formContainer.innerHTML = previewHtml;
    formContainer.style.display = 'block';
    document.getElementById('menuUploadIdle').style.display = 'none';
  }
  if (postContainer && document.getElementById('modalResult').style.display !== 'none') {
    postContainer.innerHTML = previewHtml;
    postContainer.style.display = 'block';
    const postIdle = document.getElementById('postCreateMenuIdle');
    if (postIdle) postIdle.style.display = 'none';
  }
}

function confirmMenu() {
  // Items already saved â€” switch to confirmed state (items stay visible)
  const count = accumulatedItems.length;
  const confirmedHtml = `
    <div class="menu-preview-header">
      <h4 style="color:#166534;">\u2713 ${count} \u00edtems guardados</h4>
      <span class="menu-preview-count">${photoCount} foto${photoCount > 1 ? 's' : ''}</span>
    </div>
    <div class="menu-preview">
      ${accumulatedItems.map(item => `
        <div class="menu-preview-item">
          <div>
            <span class="item-name">${escapeHtml(item.name)}</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <span class="item-category">${escapeHtml(item.category)}</span>
            <span class="item-price">RD$${item.price}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;

  const formContainer = document.getElementById('menuPreviewContainer');
  const postContainer = document.getElementById('postCreateMenuPreview');

  if (formContainer && formContainer.style.display !== 'none') {
    formContainer.innerHTML = confirmedHtml;
  }
  if (postContainer && postContainer.style.display !== 'none') {
    postContainer.innerHTML = confirmedHtml;
  }
}

function resetMenuUpload() {
  accumulatedItems = [];
  photoCount = 0;
  showMenuLoading(false);
  const formContainer = document.getElementById('menuPreviewContainer');
  if (formContainer) {
    formContainer.style.display = 'none';
    formContainer.innerHTML = '';
  }
  const idle = document.getElementById('menuUploadIdle');
  if (idle) idle.style.display = '';
}

// Close modal on overlay click
document.getElementById('newModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});
</script>
</body>
</html>
